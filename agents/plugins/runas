#!/bin/bash
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

# Disable unused variable error (needed to keep track of version)
# shellcheck disable=SC2034
VERSION="2.0.0i2"

# This plugin allows to execute mrpe, local and plugin skripts with a different user context
# It is configured with in the file $MK_CONFDIR/runas.cfg
#
# Syntax:
# [Script type] [User context] [File / Directory]
#
# Example configuration
# # Execute mrpe commands in given files under specific user
# # A '-' means no user context switch
# mrpe ab /home/ab/mrpe_commands.cfg
# mrpe lm /home/lm/mrpe_commands.cfg
# mrpe - /root/mrpe/extra_commands.cfg
#
# Excecute -executable- files in the target directories under specific user context
# plugin ab /var/ab/plugins
# local ab /var/ab/local
#

grep -Ev '^[[:space:]]*($|#)' "$MK_CONFDIR/runas.cfg" | \
while read type user include
do
    if [ -d $include -o \( "$type" == "mrpe" -a -f $include \) ] ; then
        PREFIX=""
        if [ "$user" != "-" ] ; then
            PREFIX="su $user -c "
        fi

        # mrpe includes
        if [ "$type" == "mrpe" ] ; then
            echo "<<<mrpe>>>"
            grep -Ev '^[[:space:]]*($|#)' "$include" | \
            while read descr cmdline
            do
                PLUGIN=${cmdline%% *}
                if [ -n "$PREFIX" ] ; then
                    cmdline="$PREFIX\"$cmdline\""
                fi
                OUTPUT=$(eval "$cmdline")
                echo -n "(${PLUGIN##*/}) $descr $? $OUTPUT" | tr \\n \\1
                echo
            done
        # local and plugin includes
        elif [ "$type" == "local" -o "$type" == "plugin" ] ; then
            if [ "$type" == "local" ] ; then
                echo "<<<local:sep(0)>>>"
            fi
            find $include -executable -type f | \
            while read filename
            do
                if [ -n "$PREFIX" ] ; then
                    cmdline="$PREFIX\"$filename\""
                else
                    cmdline=$filename
                fi
                $cmdline
            done
        fi
    fi
done
