# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

#
# Patch MSI file with new production code
# Expects, that any Python 3 installed
#
# Usage:
#  make msi_patch


TOP_SRC_DIR     := ..\..
ARTE_PATH       = $(TOP_SRC_DIR)\artefacts

MSI_STATE_FILE 	= $(ARTE_PATH)\msi_state_data.yml
MSI_AGENT_FILE 	= $(ARTE_PATH)\check_mk_agent.msi
MSI_PATCH_FILE 	= $(TOP_SRC_DIR)\cmk\utils\msi_patch.py

EXTLIBS         := extlibs

PACKAGE_ASIO 	:= $(TOP_SRC_DIR)\omd\packages\asio
# ATTENTION: this value is hardcoded in the vcxproj files - fix it, please, too
ASIO_VERSION 	:= asio-1.24.0

PACKAGE_FMT     := $(TOP_SRC_DIR)\omd\packages\fmt
# ATTENTION: this value is hardcoded in the vcxproj files - fix it, please, too
FMT_VERSION    := fmt-9.0.0

PACKAGE_OHM     := $(TOP_SRC_DIR)\omd\packages\openhardwaremonitor
# ATTENTION: this value is hardcoded in the vcxproj files - fix it, please, too
OHM_VERSION    := openhardwaremonitor-0.9.6




$(MSI_STATE_FILE): $(MSI_AGENT_FILE) $(MSI_PATCH_FILE)
	@powershell Write-Host "Patching '$(MSI_AGENT_FILE)'" -Foreground Green
	@del $(MSI_STATE_FILE)  2> nul
	@python.exe --version
	python.exe $(MSI_PATCH_FILE) 1033 $(MSI_AGENT_FILE) $(MSI_STATE_FILE)

msi_patch: $(MSI_STATE_FILE)
	@if NOT exist "$(MSI_STATE_FILE)" powershell Write-Host "Patch of '$(MSI_AGENT_FILE)' failed" -Foreground Red && exit /b 1
	@powershell Write-Host "Patch of '$(MSI_AGENT_FILE)' success" -Foreground Green
	@type $(MSI_STATE_FILE)
	@exit /b 0

clean_artifacts:
	@set arte=$(ARTE_PATH)&& call scripts\clean_artifacts.cmd


setversion:
	@python patch_windows_agent_version.py src\common\wnx_version.h $(NEW_VERSION)

install_extlibs: $(EXTLIBS)\$(ASIO_VERSION) $(EXTLIBS)\$(FMT_VERSION) $(EXTLIBS)\$(OHM_VERSION)

$(EXTLIBS)\$(ASIO_VERSION): $(PACKAGE_ASIO)/$(ASIO_VERSION).tar.gz
	@if "$(EXTLIBS)" == "" echo bad extlibs && exit 1
	@if "$(ASIO_VERSION)" == "" echo bad asio_version && exit 1
	@rmdir /s /q .\$@ 2> nul || echo "directory $@ is absent, ok!"
	@scripts\unpack_package.cmd 7z $(PACKAGE_ASIO) $(ASIO_VERSION) $(EXTLIBS) $(ASIO_VERSION) *
	@powershell (Get-Item $@).LastWriteTime = (Get-Date)

$(EXTLIBS)\$(FMT_VERSION): $(PACKAGE_FMT)/$(FMT_VERSION).tar.gz
	@if "$(EXTLIBS)" == "" echo bad extlibs && exit 1
	@if "$(FMT_VERSION)" == "" echo bad fmt_version && exit 1
	@rmdir /s /q .\$@ 2> nul || echo "directory $@ is absent, ok!"
	@scripts\unpack_package.cmd 7z $(PACKAGE_FMT) $(FMT_VERSION) $(EXTLIBS) $(FMT_VERSION) *
	@powershell (Get-Item $@).LastWriteTime = (Get-Date)

$(EXTLIBS)\$(OHM_VERSION): $(PACKAGE_OHM)/$(OHM_VERSION).zip
	@if "$(EXTLIBS)" == "" echo bad extlibs && exit 1
	@if "$(OHM_VERSION)" == "" echo bad fmt_version && exit 1
	@rmdir /s /q .\$@ 2> nul || echo "directory $@ is absent, ok!"
	@7z x $? -o$(EXTLIBS) > nul 2>&1
	@powershell (Get-Item $@).LastWriteTime = (Get-Date)



