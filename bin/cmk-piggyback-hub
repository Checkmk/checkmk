#!/usr/bin/env python3
# Copyright (C) 2024 Checkmk GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

import sys
import traceback
from typing import Literal

from cmk.ccc.crash_reporting import ABCCrashReport, CrashReportStore, make_crash_report_base_path
from cmk.ccc.version import get_general_version_infos
from cmk.piggyback.hub import main
from cmk.utils.paths import omd_root


class PiggybackHubCrashReport(ABCCrashReport[None]):
    @classmethod
    def type(cls) -> Literal["piggyback-hub"]:
        return "piggyback-hub"


def create_crash_report_callback() -> str:
    try:
        crash = PiggybackHubCrashReport(
            crash_report_base_path=make_crash_report_base_path(omd_root),
            crash_info=PiggybackHubCrashReport.make_crash_info(
                get_general_version_infos(omd_root), None
            ),
        )
        CrashReportStore().save(crash)
        return f"Please submit a crash report! (Crash-ID: {crash.ident_to_text()})"
    except Exception:
        return f"Failed to create a crash report: {traceback.format_exc()}"


if __name__ == "__main__":
    sys.exit(main(crash_report_callback=create_crash_report_callback))
