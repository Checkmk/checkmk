#!/bin/bash
# Copyright (C) 2023 Checkmk GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

set -e -o pipefail
REPO_PATH="$(git rev-parse --show-toplevel)"
PREVIOUS_IMAGE_FILENAME="${REPO_PATH}/version_txt_from_previous_run"
CURRENT_IMAGE_VERSION_FILENAME="/version.txt"

log() {
    echo "ensure-workspace-integrity: ${1}"
}

update_previous_used_image() {
    log "Updating ${PREVIOUS_IMAGE_FILENAME} from ${CURRENT_IMAGE_FILENAME}... "
    cat "${CURRENT_IMAGE_VERSION_FILENAME}" >"${PREVIOUS_IMAGE_FILENAME}"
}

if ! test -f "${PREVIOUS_IMAGE_FILENAME}"; then
    log "${PREVIOUS_IMAGE_FILENAME} does not exists (yet)"
    # We have no information regarding the previously used image in that workspace
    # * blow away other aritfacts which may be incompatible now
    git clean -f -d -x --exclude="/home_docker" --exclude="/container_shadow_workspace*" --exclude="/shared_cargo_folder"
    update_previous_used_image
    exit 0
fi

if cmp -s "${PREVIOUS_IMAGE_FILENAME}" ${CURRENT_IMAGE_VERSION_FILENAME}; then
    log "${PREVIOUS_IMAGE_FILENAME} and ${CURRENT_IMAGE_VERSION_FILENAME} are the same."
    # Clean the workspace with the following logic:
    # * don't clean .gitignore-d stuff (e.g. .venv or mypy cache) -> we want fast execution
    # * clean stuff which might got generated by previous runs -> they might create false failures
    git clean -f -d --exclude="/home_docker" --exclude="/container_shadow_workspace*" --exclude="/shared_cargo_folder"
else
    log "${PREVIOUS_IMAGE_FILENAME} and ${CURRENT_IMAGE_VERSION_FILENAME} differ!"
    # IMAGE_TESTING changed in relation to the previous run in that workspace.
    # * blow away other aritfacts which may be incompatible now
    git clean -f -d -x --exclude="/home_docker" --exclude="/container_shadow_workspace*" --exclude="/shared_cargo_folder"
    update_previous_used_image
fi
