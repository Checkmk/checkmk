#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# License: GNU General Public License v2
#
# created by thl-cmk[at]outlook[dot]com
#
# Monitors Cisco ASA temperatur sensors
# works with Cisco ASA 55xx-X and later
# tested with 5506W and 5512-X, 5585-SSP20
# 24.03.2016: changed "47.1.1.1.1.2" PhysDescription to "47.1.1.1.1.7" entPhysicalName (duplicate descr. with ASA5585)
# 02.07.2016: fixed crit/warn to >=
# 09.01.2018: minimum temp value added
# 03.05.2018: fixed inventory for empty sensorname (asa context)
# 24.02.2020: rewritten for cmk 1.6.x, includes "temperature.include"
#             Note: item has ben changed from "Environment: <sensorname" to "Temperature <sensorname>
#             Note: wato/metrics changed to use CMK build in template
# 30.05.2020: cleanup.
#

factory_settings['cisco_asa_temp_default_levels'] = {}


def inventory_cisco_asa_temp(info):
    for sensorname, sensortype, sensorvalue, sensorstatus, sensorunits in info:
        if sensortype == '8' and sensorstatus == '1' and sensorname != '':
            yield sensorname, None


def check_cisco_asa_temp(item, params, info):
    for sensorname, sensortype, sensorvalue, sensorstatus, sensorunits in info:
        if sensorname == item and sensortype == '8':
            yield check_temperature(
                reading=float(sensorvalue),
                params=params,
                unique_name='cisco_asa_temp_%s' % sensorname,
            )


check_info['cisco_asa_temp'] = {
    'check_function': check_cisco_asa_temp,
    'inventory_function': inventory_cisco_asa_temp,
    'service_description': 'Temperature %s',
    'has_perfdata': True,
    'group': 'temperature',
    'default_levels_variable': 'cisco_asa_temp_default_levels',
    'snmp_scan_function': lambda oid: oid('.1.3.6.1.2.1.1.1.0').lower().startswith(
        'cisco adaptive security appliance'),
    'snmp_info': (
        '.1.3.6.1.2.1',
        [
            '47.1.1.1.1.7',  #ENTITY-MIB::entPhysicalName
            '99.1.1.1.1',  #ENTITY-SENSOR-MIB::entPhySensorType
            '99.1.1.1.4',  #ENTITY-SENSOR-MIB::entPhySensorValue
            '99.1.1.1.5',  #ENTITY-SENSOR-MIB::entPhySensorOperStatus
            '99.1.1.1.6',  #ENTITY-SENSOR-MIB::entPhySensorUnitsDisplay
        ]),
    'includes': ['temperature.include'],
}
