#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

import cmk.base.plugins.agent_based.utils.docker as docker

def parse_docker_container_labels(info):
    '''process the first line to a JSON object

    In case there are multiple lines of output sent by the agent only process the first
    line. We assume that this a full JSON object. The rest of the section is skipped.
    When a container got piggyback data from multiple hosts (e.g. a cluster) this results
    in multiple JSON objects handed over to this check.
    '''
    version = docker.get_version(info)  # pylint: disable=undefined-variable

    index = 0 if version is None else 1
    parsed = docker.json_get_obj(info[index]) or {} if info[index:] else {}  # pylint: disable=undefined-variable

    if version is None:
        return DeprecatedDict(parsed)  # pylint: disable=undefined-variable
    return parsed

def discover_docker_container_labels(parsed):
    for label, value in parsed.items():
        yield HostLabel('docker/%s' % label, value)

check_info['docker_container_labels'] = {
    'parse_function': parse_docker_container_labels,
    'inventory_function': discover_docker_container_labels,
    'service_description': 'Docker container labels',
    'includes': ['legacy_docker.include'],
}
