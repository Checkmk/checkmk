#!/usr/bin/python
#author: Oguzhan Cicek, OpenSource Security GmbH - oguzhan(at)os-s.de

#Example Input:
#.1.3.6.1.2.1.1.1.0 testname
#.1.3.6.1.2.1.1.2.0 .1.3.6.1.4.1.12356.101.1.15000
#[...]
#.1.3.6.1.4.1.12356.101.13.1.1.0 3
#.1.3.6.1.4.1.12356.101.13.1.2.0 11
#.1.3.6.1.4.1.12356.101.13.1.3.0 128
#.1.3.6.1.4.1.12356.101.13.1.4.0 2
#.1.3.6.1.4.1.12356.101.13.1.5.0 2
#.1.3.6.1.4.1.12356.101.13.1.6.0 4
#.1.3.6.1.4.1.12356.101.13.1.7.0 test
#.1.3.6.1.4.1.12356.101.13.2.1.1.1.1 1
#[...]

#Example GUI Output:
#OK	Fortigate High Availability	System Mode: activePassive, Priority: 128, Schedule= roundRobin, Group Id: 11, Group Name: test		fortigate_ha


def inventory_fortigate_ha(info):
    if info:
        return [(None, None)]


def check_fortigate_ha(item, params, info):
    state = 0
    gid = info[0][0][1]
    prio = info[0][0][2]
    gname = info[0][0][4]
    mode_code = int(info[0][0][0])
    system_modes = {
        1: 'standalone',
        2: 'activeActive',
        3: 'activePassive',
    }
    mode = system_modes[mode_code]
    sched_code = int(info[0][0][3])
    lbsched_modes = {
        1: 'none',
        2: 'hub',
        3: 'leastConnections',
        4: 'roundRobin',
        5: 'weightedRoundRobin',
        6: 'random',
        7: 'ipBased',
        8: 'ipPortBased',
    }
    sched = lbsched_modes[sched_code]

    statustext = "System Mode: %s, Priority: %s, Schedule= %s, Group Id: %s, Group Name: %s" % (
        mode, prio, sched, gid, gname)
    yield state, statustext


check_info['fortigate_ha'] = {
    'inventory_function': inventory_fortigate_ha,
    'check_function': check_fortigate_ha,
    'has_perfdata': False,
    'service_description': "Fortigate High Availability",
    'snmp_info': [(
        '.1.3.6.1.4.1.12356.101.13.1',
        [
            '1',  # fgHaSystemMode
            '2',  # fgHaGroupId
            '3',  # fgHaPriority
            '6',  # fgHaSchedule
            '7',  # fgHaGroupName
        ])],
    'snmp_scan_function': lambda oid: oid(".1.3.6.1.2.1.1.2.0").startswith(
        ".1.3.6.1.4.1.12356.101.1."),
}
