#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.


def parse_fortigate_sslvpn(info):
    return [x + y for x, y in zip(info[0], info[1])]


def inventory_fortigate_sslvpn(info):
    for name, _state, _users, _web_sessions, _tunnels, _tunnels_max in info:
        yield name, None


def check_fortigate_sslvpn(item, _no_params, info):
    fn_bool_state = {"1": "disabled", "2": "enabled"}
    for name, state, users, web_sessions, tunnels, tunnels_max in info:
        if name == item:
            infotext = "%s - users %s, web sessions %s, tunnels %s" %\
                (fn_bool_state[state], users, web_sessions, tunnels)

            perfdata = [("active_vpn_users", users), ("active_vpn_websessions", web_sessions),
                        ("active_vpn_tunnels", tunnels, '', '', 0, tunnels_max)]
            return 0, infotext, perfdata


check_info["fortigate_sslvpn"] = {
    "inventory_function": inventory_fortigate_sslvpn,
    "check_function": check_fortigate_sslvpn,
    "parse_function": parse_fortigate_sslvpn,
    "service_description": "VPN SSL %s",
    "has_perfdata": True,
    "snmp_scan_function": lambda oid: ".1.3.6.1.4.1.12356.101.1" in oid(".1.3.6.1.2.1.1.2.0"),
    "snmp_info": [
        (".1.3.6.1.4.1.12356.101.3.2.1.1", [2]),
        (
            ".1.3.6.1.4.1.12356.101.12.2.3.1",
            [
                1,  # fgVpnSslState
                2,  # fgVpnSslStatsLoginUsers
                4,  # fgVpnSslStatsActiveWebSessions
                6,  # fgVpnSslStatsActiveTunnels
                7,  # fgVpnSslStatsMaxTunnels
            ]),
    ]
}
