#!/usr/bin/python
#author: Oguzhan Cicek, OpenSource Security GmbH - oguzhan(at)os-s.de

#Example Input:
#[...]
#.1.3.6.1.4.1.12356.105.1.1.0 FortiMail-VM
#.1.3.6.1.4.1.12356.105.1.2.0 FEVM1234567890
#.1.3.6.1.4.1.12356.105.1.3.0 v5.4,build719,180328 (5.4.5 GA)
#.1.3.6.1.4.1.12356.105.1.4.0 68.386(05/09/2019 02:21)
#.1.3.6.1.4.1.12356.105.1.5.0 1
#.1.3.6.1.4.1.12356.105.1.6.0 0
#.1.3.6.1.4.1.12356.105.1.7.0 23
#.1.3.6.1.4.1.12356.105.1.8.0 0
#.1.3.6.1.4.1.12356.105.1.9.0 0
#.1.3.6.1.4.1.12356.105.1.10.0 2
#.1.3.6.1.4.1.12356.105.1.30.0 5
#.1.3.6.1.4.1.12356.105.1.101.1.0 15
#.1.3.6.1.4.1.12356.105.1.101.2.0 0
#.1.3.6.1.4.1.12356.105.1.102.2.1.1.1 1
#.1.3.6.1.4.1.12356.105.1.102.2.1.1.2 2
#.1.3.6.1.4.1.12356.105.1.102.2.1.2.1 6
#.1.3.6.1.4.1.12356.105.1.102.2.1.2.2 6
#.1.3.6.1.4.1.12356.105.1.102.2.1.3.1 172.31.104.70
#.1.3.6.1.4.1.12356.105.1.102.2.1.3.2 172.29.254.22
#.1.3.6.1.4.1.12356.105.1.102.2.1.4.1 "00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 "
#.1.3.6.1.4.1.12356.105.1.102.2.1.4.2 "00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 "
#.1.3.6.1.4.1.12356.105.1.102.2.1.5.1 514
#.1.3.6.1.4.1.12356.105.1.102.2.1.5.2 514
#.1.3.6.1.4.1.12356.105.1.102.2.1.6.1 172.31.100.31
#.1.3.6.1.4.1.12356.105.1.102.2.1.6.2 172.31.38.31
#.1.3.6.1.4.1.12356.105.1.102.2.1.7.1 "00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 "
#.1.3.6.1.4.1.12356.105.1.102.2.1.7.2 "00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 "
#.1.3.6.1.4.1.12356.105.1.102.2.1.8.1 51164
#.1.3.6.1.4.1.12356.105.1.102.2.1.8.2 42958
#.1.3.6.1.4.1.12356.105.1.102.2.1.9.1 540
#.1.3.6.1.4.1.12356.105.1.102.2.1.9.2 0
#.1.3.6.1.4.1.12356.105.1.103.1.0 0
#.1.3.6.1.4.1.12356.105.1.103.2.1.1.1 1
#.1.3.6.1.4.1.12356.105.1.103.2.1.1.2 2
#.1.3.6.1.4.1.12356.105.1.103.2.1.1.3 3
#.1.3.6.1.4.1.12356.105.1.103.2.1.1.4 4
#.1.3.6.1.4.1.12356.105.1.103.2.1.1.5 5
#.1.3.6.1.4.1.12356.105.1.103.2.1.1.6 6
#.1.3.6.1.4.1.12356.105.1.103.2.1.2.1 default queue
#.1.3.6.1.4.1.12356.105.1.103.2.1.2.2 default slow queue
#.1.3.6.1.4.1.12356.105.1.103.2.1.2.3 incoming queue
#.1.3.6.1.4.1.12356.105.1.103.2.1.2.4 incoming slow queue
#.1.3.6.1.4.1.12356.105.1.103.2.1.2.5 outgoing queue
#.1.3.6.1.4.1.12356.105.1.103.2.1.2.6 outgoing slow queue
#.1.3.6.1.4.1.12356.105.1.103.2.1.3.1 0
#.1.3.6.1.4.1.12356.105.1.103.2.1.3.2 31
#.1.3.6.1.4.1.12356.105.1.103.2.1.3.3 0
#.1.3.6.1.4.1.12356.105.1.103.2.1.3.4 0
#.1.3.6.1.4.1.12356.105.1.103.2.1.3.5 0
#.1.3.6.1.4.1.12356.105.1.103.2.1.3.6 0
#.1.3.6.1.4.1.12356.105.1.103.2.1.4.1 0
#.1.3.6.1.4.1.12356.105.1.103.2.1.4.2 534
#.1.3.6.1.4.1.12356.105.1.103.2.1.4.3 0
#.1.3.6.1.4.1.12356.105.1.103.2.1.4.4 0
#.1.3.6.1.4.1.12356.105.1.103.2.1.4.5 0
#.1.3.6.1.4.1.12356.105.1.103.2.1.4.6 0
#.1.3.6.1.4.1.12356.105.1.110.1.0 2
#.1.3.6.1.4.1.12356.105.1.110.2.1.1.1 1
#.1.3.6.1.4.1.12356.105.1.110.2.1.1.2 2
#.1.3.6.1.4.1.12356.105.1.110.2.1.2.1 ps1
#.1.3.6.1.4.1.12356.105.1.110.2.1.2.2 ps2
#.1.3.6.1.4.1.12356.105.1.110.2.1.3.1 not-present
#.1.3.6.1.4.1.12356.105.1.110.2.1.3.2 not-present
#.1.3.6.1.4.1.12356.105.1.110.2.1.4.1 1
#.1.3.6.1.4.1.12356.105.1.110.2.1.4.2 1
#.1.3.6.1.4.1.12356.105.1.200.1.0 3
#.1.3.6.1.4.1.12356.105.1.200.2.0 3

#Example GUI Output:
#OK	FortiMail serial		Model: FortiMail-VM, Serial: FEVM1234567890, Firmware: v5.4,build719,180328 (5.4.5 GA)
#OK	Mail disk			Mail Disk usage: 0%
#OK	Mail System load		Mail System load: 5%
#OK	Mail default queue		Mail count 0 - Mail size 0KB
#OK	Mail default slow queue		Mail count 31 - Mail size 534KB
#OK	Mail incoming queue		Mail count 0 - Mail size 0KB
#OK	Mail incoming slow queue	Mail count 0 - Mail size 0KB
#OK	Mail outgoing queue		Mail count 0 - Mail size 0KB
#OK	Mail outgoing slow queue	Mail count 0 - Mail size 0KB

###################################################
# |  \/  |     (_) |  / __ \
# | \  / | __ _ _| | | |  | |_   _  ___ _   _  ___
# | |\/| |/ _` | | | | |  | | | | |/ _ \ | | |/ _ \
# | |  | | (_| | | | | |__| | |_| |  __/ |_| |  __/
# |_|  |_|\__,_|_|_|  \___\_\\__,_|\___|\__,_|\___|
###################################################

factory_settings["fortimail_default_levels"] = {
    "mcount": (100, 200),
}


def parse_fortimail(info):
    parsed = {"sysload": info[0], "serial": info[1], "disk": info[2], "queue": info[3]}
    return parsed


def inventory_fortimail(parsed):
    for p in parsed['queue']:
        yield (p[0], "fortimail_default_levels")


def check_fortimail(item, params, parsed):
    warn, crit = params["mcount"]
    state = 0
    for p in parsed['queue']:
        if p[0] == item:
            _, mcount, msize = p
            queuetext = "Mail count %s - Mail size %sKB" % (mcount, msize)
            state = 0
            if int(mcount) >= warn:
                state = 1
            if int(mcount) >= crit:
                state = 2
            if int(mcount) < 0:
                state = 3
    perfdata = [("mail count", int(mcount), warn, crit)]
    yield state, queuetext, perfdata


check_info['fortimail'] = {
    'parse_function': parse_fortimail,
    'inventory_function': inventory_fortimail,
    'check_function': check_fortimail,
    'service_description': "Mail %s",
    'has_perfdata': True,
    'snmp_info': [
        (
            '.1.3.6.1.4.1.12356.105.1',
            [
                '30',  # fmlSysLoad
            ]),
        (
            '.1.3.6.1.4.1.12356.105.1',
            [
                '1',  # fmlSysModel
                '2',  # fmlSysSerial
                '3',  # fmlSysVersion
            ]),
        (
            '.1.3.6.1.4.1.12356.105.1',
            [
                '9',  # fmlSysMailDiskUsage
            ]),
        (
            '.1.3.6.1.4.1.12356.105.1.103.2.1',
            [
                '2',  # fmlMailQueueName
                '3',  # fmlMailQueueMailCount
                '4',  # fmlMailQueueMailSize
            ])
    ],
    'snmp_scan_function': lambda oid: '.1.3.6.1.4.1.12356.105' in oid('.1.3.6.1.2.1.1.2.0').lower(),
    'group': 'fortimail',
    'default_levels_variable': 'fortimail_default_levels',
}

##############################################################
#  / ____|         | |               | |                   | |
# | (___  _   _ ___| |_ ___ _ __ ___ | |     ___   __ _  __| |
#  \___ \| | | / __| __/ _ \ '_ ` _ \| |    / _ \ / _` |/ _` |
#  ____) | |_| \__ \ ||  __/ | | | | | |___| (_) | (_| | (_| |
# |_____/ \__, |___/\__\___|_| |_| |_|______\___/ \__,_|\__,_|
#          __/ |
#         |___/
##############################################################

factory_settings["fortimail_sysload_default_levels"] = {
    "mail_sysload": (90, 95),
}


def inventory_fortimail_sysload(parsed):
    for _ in parsed['sysload']:
        yield ('', "fortimail_sysload_default_levels")


def check_fortimail_sysload(item, params, parsed):
    warn, crit = params["mail_sysload"]
    state = 0
    sysload = parsed['sysload'][0][0]
    statustext = "Mail System load: %s%%" % sysload
    if int(sysload) >= warn:
        state = 1
    if int(sysload) >= crit:
        state = 2
    if int(sysload) > 100 or int(sysload) < 0:
        state = 3
    perfdata = [("system load", int(sysload), warn, crit)]
    yield state, statustext, perfdata


check_info['fortimail.sysload'] = {
    'inventory_function': inventory_fortimail_sysload,
    'check_function': check_fortimail_sysload,
    'service_description': "Mail System load",
    'has_perfdata': True,
    'group': 'fortimail_sysload',
    'default_levels_variable': 'fortimail_sysload_default_levels',
}

##############################
#  / ____|         (_)     | |
# | (___   ___ _ __ _  __ _| |
#  \___ \ / _ \ '__| |/ _` | |
#  ____) |  __/ |  | | (_| | |
# |_____/ \___|_|  |_|\__,_|_|
##############################


def inventory_fortimail_serial(parsed):
    for _ in parsed['serial']:
        yield ("", None)


def check_fortimail_serial(item, params, parsed):
    state = 0
    model, serial, fversion = parsed['serial'][0]
    statustext = "Model: %s, Serial: %s, Firmware: %s" % (model, serial, fversion)
    yield state, statustext


check_info['fortimail.serial'] = {
    'inventory_function': inventory_fortimail_serial,
    'check_function': check_fortimail_serial,
    'service_description': "FortiMail serial",
    'has_perfdata': False,
}

######################################
# |  \/  |     (_) |  __ \(_)   | |
# | \  / | __ _ _| | |  | |_ ___| | __
# | |\/| |/ _` | | | |  | | / __| |/ /
# | |  | | (_| | | | |__| | \__ \   <
# |_|  |_|\__,_|_|_|_____/|_|___/_|\_\
######################################

factory_settings["fortimail_disk_default_levels"] = {
    "mail_disk_usage": (80, 90),
}


def inventory_fortimail_disk(parsed):
    for _ in parsed['disk']:
        yield ('', "fortimail_disk_default_levels")


def check_fortimail_disk(item, params, parsed):
    warn, crit = params["mail_disk_usage"]
    state = 0
    musage = parsed['disk'][0][0][0]
    statustext = "Mail Disk usage: %s%%" % musage
    if int(musage) >= warn:
        state = 1
    if int(musage) >= crit:
        state = 2
    if int(musage) > 100 or int(musage) < 0:
        state = 3
    perfdata = [("mail disk usage", int(musage), warn, crit)]
    yield state, statustext, perfdata


check_info['fortimail.disk'] = {
    'inventory_function': inventory_fortimail_disk,
    'check_function': check_fortimail_disk,
    'service_description': "Mail disk",
    'has_perfdata': True,
    'group': 'fortimail_disk',
    'default_levels_variable': 'fortimail_disk_default_levels',
}
