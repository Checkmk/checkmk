#!/usr/bin/python
# author: Oguzhan Cicek, OpenSource Security GmbH - oguzhan(at)os-s.de

# Example Input:
#[...]
#.1.3.6.1.4.1.12356.118.3.1.1.0 v2.52-build0340 (GA)
#.1.3.6.1.4.1.12356.118.3.1.2.0 2
#.1.3.6.1.4.1.12356.118.3.1.3.0 4
#.1.3.6.1.4.1.12356.118.3.1.4.0 260459760
#.1.3.6.1.4.1.12356.118.3.1.5.0 710698
#.1.3.6.1.4.1.12356.118.3.1.6.0 3754417
#.1.3.6.1.4.1.12356.118.3.1.7.0 2
#.1.3.6.1.4.1.12356.118.3.1.8.0 32908349
#.1.3.6.1.4.1.12356.118.3.2.1.0 5.2.50534
#.1.3.6.1.4.1.12356.118.3.2.2.0 2.4.20034
#.1.3.6.1.4.1.12356.118.3.2.3.0 3.2.279
#.1.3.6.1.4.1.12356.118.3.2.4.0 4.478
#.1.3.6.1.4.1.12356.118.3.2.5.0 14.613
#[...]

# Example GUI Output:
# OK	FortiSandbox Disk usage	5.28% used (694.04 GB of 3.58 TB)

factory_settings["fortisandbox_disk_default_levels"] = {
    "disk_usage": (80, 90),
}


def inventory_fortisandbox_disk(info):
    for _ in info:
        yield (None, "fortisandbox_disk_default_levels")


def convert_size(size_bytes):
    if size_bytes == 0:
        return "0 MB"
    i = 0
    size_name = ("MB", "GB", "TB", "PB", "EB", "ZB", "YB")
    while size_bytes >= 1000:
        size_bytes = float(size_bytes / 1024)
        i = i + 1
    return "%.2f %s" % (size_bytes, size_name[i])


def check_fortisandbox_disk(item, params, info):
    warn, crit = params["disk_usage"]
    dusage = float(info[0][0][0])
    dcap = float(info[0][0][1])
    dperc = float(dcap / dusage)
    display_diskusage = convert_size(dusage)
    display_diskcap = convert_size(dcap)
    statustext = "%.2f%% used (%s of %s)" % (dperc, display_diskusage, display_diskcap)
    perfdata = [("disk usage", dperc)]
    state = 0
    if dperc >= warn:
        state = 1
    if dperc >= crit:
        state = 2
    if dperc > 100 or dperc < 0:
        state = 3
    yield state, statustext, perfdata


check_info['fortisandbox_disk'] = {
    'inventory_function': inventory_fortisandbox_disk,
    'check_function': check_fortisandbox_disk,
    'has_perfdata': True,
    'service_description': "FortiSandbox Disk usage",
    'snmp_info': [(
        '.1.3.6.1.4.1.12356.118.3.1',
        [
            '5',  # fraSysDiskUsage
            '6',  # fraSysDiskCapacity
        ])],
    'snmp_scan_function': lambda oid: '.1.3.6.1.4.1.12356.118.1.30006' in oid('.1.3.6.1.2.1.1.2.0').
                          lower(),
    'group': 'fortisandbox_disk',
    'default_levels_variable': 'fortisandbox_disk_default_levels',
}
