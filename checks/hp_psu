#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

from cmk.base.check_legacy_includes.hp import *  # pylint: disable=wildcard-import,unused-wildcard-import
from cmk.base.check_legacy_includes.temperature import *  # pylint: disable=wildcard-import,unused-wildcard-import


def parse_hp_psu(info):
    parsed = {index: {"temp": int(temp), "status": dev_status} for index, dev_status, temp in info}
    return parsed


#   .--Temperature---------------------------------------------------------.
#   |     _____                                   _                        |
#   |    |_   _|__ _ __ ___  _ __   ___ _ __ __ _| |_ _   _ _ __ ___       |
#   |      | |/ _ \ '_ ` _ \| '_ \ / _ \ '__/ _` | __| | | | '__/ _ \      |
#   |      | |  __/ | | | | | |_) |  __/ | | (_| | |_| |_| | | |  __/      |
#   |      |_|\___|_| |_| |_| .__/ \___|_|  \__,_|\__|\__,_|_|  \___|      |
#   |                       |_|                                            |
#   '----------------------------------------------------------------------'

factory_settings["hp_psu_temp_default_levels"] = {
    "levels": (70, 80),
}


def inventory_hp_psu_temp(parsed):
    for index in parsed:
        yield index, {}


@get_parsed_item_data
def check_hp_psu_temp(item, params, data):
    # For some status, the device simply reports 0 as a temperature value.
    temp_unknown_status = ["8"]
    if data["status"] in temp_unknown_status and data["temp"] == 0:
        return 3, "No temperature data available"
    return check_temperature(data["temp"], params, item)


check_info['hp_psu.temp'] = {
    'default_levels_variable': "hp_psu_temp_default_levels",
    'inventory_function': inventory_hp_psu_temp,
    'check_function': check_hp_psu_temp,
    'service_description': "Temperature Power Supply %s",
    'group': "temperature",
    'has_perfdata': True,
}

#   .--Status--------------------------------------------------------------.
#   |                    ____  _        _                                  |
#   |                   / ___|| |_ __ _| |_ _   _ ___                      |
#   |                   \___ \| __/ _` | __| | | / __|                     |
#   |                    ___) | || (_| | |_| |_| \__ \                     |
#   |                   |____/ \__\__,_|\__|\__,_|___/                     |
#   |                                                                      |
#   '----------------------------------------------------------------------'


def inventory_hp_psu(parsed):
    for item in parsed:
        yield item, None


def check_hp_psu(item, params, parsed):
    ps_statemap = {
        "1": (2, "Not present"),
        "2": (2, "Not plugged"),
        "3": (0, "Powered"),
        "4": (1, "Failed"),
        "5": (2, "Permanent Failure"),
        "6": (3, "Max"),
        # This value is not specified in the MIB, but has been observed in the wild.
        "8": (2, "Unplugged"),
        "9": (2, "Aux not powered"),
    }

    return ps_statemap.get(parsed[item]["status"], (3, "Unknown status code sent by device"))


check_info['hp_psu'] = {
    'parse_function': parse_hp_psu,
    'inventory_function': inventory_hp_psu,
    'check_function': check_hp_psu,
    'service_description': 'Power Supply Status %s',
    'snmp_info': (
        '.1.3.6.1.4.1.11.2.14.11.5.1.55.1.1.1',  # POWERSUPPLY_MIB: hpicfPsEntry
        [
            OID_END,  # hpicfPsBayNum
            "2",  # hpicfPsState
            "4",  # hpicfPsTemp
        ]),
    'snmp_scan_function': scan_hp,
}
