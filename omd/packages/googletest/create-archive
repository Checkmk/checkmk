#!/bin/bash
set -e

# Googletest doesn't provide releases anymore, it uses a "Abseil Live at Head philosophy" nowadays.
SHA=71140c3ca7

rm -rf googletest
git clone \
    --depth=1 \
    --single-branch \
    --branch=main \
    git@github.com:google/googletest.git
cd googletest
git checkout --detach ${SHA}
git apply ../googletest.diff
git config user.name "John Doe"
git config user.email "john@doe.com"
git commit --all --message="Applied local patches"
git archive \
    --prefix=googletest-${SHA}-patched/ \
    --output=../googletest-${SHA}-patched.tar.gz \
    -9 \
    HEAD
cd ..
rm -rf googletest
