#!/bin/sh

# Alias: Restrict livestatus port to IP addresses
# Menu: Distributed Monitoring
# Description:
#  If Livestatus is configured to listen on a TCP port, you
#  can configure the IP addresses that are allowed to
#  connect to livestatus here. The setting "0.0.0.0 ::/0" makes the
#  port available to all IPv4 and IPv6 clients,

case "$1" in
    default)
        echo "0.0.0.0 ::/0"
    ;;
    choices)
        echo "(?:(?:[\d]{1,3})\.(?:[\d]{1,3})\.(?:[\d]{1,3})\.(?:[\d]{1,3})(/[0-9]{1,2})?\s?)+"
    ;;
    set)
        sed -ri "s@#?([[:space:]]*only_from[[:space:]]*=[[:space:]]*)(.*)@\1$2@" $OMD_ROOT/etc/mk-livestatus/xinetd.conf
        perl -pi -e 's@(IPAddressAllow=).*$@\1'"$2"'@g' "$OMD_ROOT/etc/mk-livestatus/livestatus.socket"
    ;;
    depends)
        [ "$CONFIG_CORE" != none ] && [ "$CONFIG_LIVESTATUS_TCP" = on ]
    ;;
esac

