#!/bin/bash
# Copyright (C) 2025 Checkmk GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

set -e

JOBS=6
readonly ALL_LINTERS=clippy

if
    getopt --test >/dev/null 2>&1
    [ $? -eq 4 ]
then
    # Provide better commandline with enhanced 'getopt' from util-linux
    GETOPT_OPTIONS=(--options 'buFl:aRCfDTj:h' --long 'build,unit-tests,check-format,lint:,all,remote-host,component-tests,format,documentation,docker-tests:,jobs:,help' --name "$(basename "$0")" --)
else
    # Compatibility with basic 'getopt' as found on non-Linux systems.
    GETOPT_OPTIONS=('buFl:aRCfDTj:h')
fi

failure() {
    test ${#@} -eq 0 || echo "$(basename "$0"):" "$@" >&2
    exit 1
}

usage() {
    echo "usage: $(basename "$0") [OPTION]..."
    echo "Run the CI pipeline or parts of it."
    echo "(long options only available on Linux)"
    echo
    echo "  -b, --build                 build executable"
    echo "  -u, --unit-tests            run unit tests"
    echo "  -F, --check-format          check for correct formatting"
    echo "  -l L,..., --lint=L,...      run linters, 'all' means '${ALL_LINTERS}'"
    echo "  -a, --all                   shortcut for -b -u -F -l all"
    echo "  -C, --component-tests       run all component tests"
    echo "  -R, --remote-host           run tests on a remote host"
    echo "  -T VER, --docker-tests=VER"
    echo "                              run component tests against Oracle Database in Docker (VER: 23, 19, 12, 11)"
    echo "  -f, --format                format sources"
    echo "  -D, --documentation         generate documentation"
    echo "  -j N, --jobs=N              allow N jobs at once, default is ${JOBS}"
    echo "  -h, --help                  show this help"
}

parse_options() {
    # Yes, all those option variables are global.
    RUN_BUILD=no
    RUN_UNIT_TESTS=no
    RUN_COMPONENT_TESTS=no
    RUN_CHECK_FORMAT=no
    RUN_CLIPPY=no
    RUN_FORMAT=no
    RUN_DOCUMENTATION=no
    RUN_COMPONENT_TESTS_REMOTE_HOST=no
    RUN_DOCKER_TESTS=no

    if ! OPTIONS=$(getopt "${GETOPT_OPTIONS[@]}" "$@"); then
        usage >&2
        failure
    fi
    eval set -- "$OPTIONS"
    unset OPTIONS

    while true; do
        case "$1" in
            '-b' | '--build')
                RUN_BUILD=yes
                shift
                ;;
            '-u' | '--unit-tests')
                RUN_UNIT_TESTS=yes
                shift
                ;;
            '-F' | '--check-format')
                RUN_CHECK_FORMAT=yes
                shift
                ;;
            '-l' | '--lint')
                test "$2" = "all" && LINTERS="${ALL_LINTERS}" || LINTERS="$2"
                for LINTER in ${LINTERS//,/ }; do
                    case ,"${ALL_LINTERS}", in
                        *,"${LINTER}",*)
                            FLAG="RUN_${LINTER//-/_}"
                            eval "${FLAG^^}=yes"
                            ;;
                        *) failure "unknown linter: ${LINTER}" ;;
                    esac
                done
                shift 2
                ;;
            '-a' | '--all')
                RUN_BUILD=yes
                RUN_UNIT_TESTS=yes
                RUN_COMPONENT_TESTS=yes
                RUN_CHECK_FORMAT=yes
                RUN_CLIPPY=yes
                shift
                ;;
            '-C' | '--component-tests')
                RUN_COMPONENT_TESTS=yes
                shift
                ;;
            '-R' | '--remote-host')
                RUN_COMPONENT_TESTS_REMOTE_HOST=yes
                shift
                ;;
            '-f' | '--format')
                RUN_FORMAT=yes
                shift
                ;;
            '-D' | '--documentation')
                RUN_DOCUMENTATION=yes
                shift
                ;;
            '-T' | '--docker-tests')
                RUN_DOCKER_TESTS=yes
                if [ -n "$2" ] && [ "${2:0:1}" != "-" ]; then
                    ORACLE_DOCKER_VERSION="$2"
                    shift
                fi
                shift
                ;;
            '-j' | '--jobs')
                JOBS="$2"
                shift 2
                ;;
            '-h' | '--help')
                usage
                exit 0
                ;;
            '--')
                shift
                test ${#@} -eq 0 || failure "extra arguments:" "$@"
                break
                ;;
            *) failure "internal error" ;;
        esac
    done

    readonly RUN_BUILD RUN_UNIT_TESTS RUN_COMPONENT_TESTS RUN_CHECK_FORMAT RUN_CLIPPY RUN_FORMAT RUN_DOCUMENTATION RUN_DOCKER_TESTS ORACLE_DOCKER_VERSION JOBS
}

run_build() {
    case "$(uname)" in
        'SunOS' | 'AIX')
            cargo build --release
            ;;
        *)
            bazel build :all
            ;;
    esac
}

run_format() {
    case "$(uname)" in
        'SunOS' | 'AIX')
            cargo fmt
            ;;
        *)
            bazel run //:format "$PWD"
            ;;
    esac
}

run_check_format() {
    case "$(uname)" in
        'SunOS' | 'AIX')
            cargo fmt --check
            ;;
        *)
            bazel run //:format.check "$PWD"
            ;;
    esac
}

setup_tests() {
    path_to_runtime="${PWD}/runtimes/plugins/packages/mk-oracle"
    mkdir -p "${path_to_runtime}"
    INSTANTCLIENT_ARCHIVE="${PWD}/runtimes/downloads/instantclient_19_28.tar.gz"
    export INSTANTCLIENT_ARCHIVE
    MK_CONFDIR="${PWD}"
    export MK_CONFDIR
    MK_LIBDIR="${PWD}/runtimes"
    export MK_LIBDIR
}

run_test_component() {
    if [[ -z "${CI_ORA2_DB_TEST_PASSWORD}" ]]; then
        failure "CI_ORA2_DB_TEST_PASSWORD is not set in the environment, component testing will fail."
    fi
    export CI_ORA2_DB_TEST="ora-rocktest.dev.checkmk.net:system:$CI_ORA2_DB_TEST_PASSWORD:1521:FREE::FREE.cmkoratest:_:_:"
    echo "CI_ORA2_DB_TEST is constructed and exported"
    setup_tests

    case "$(uname)" in
        'SunOS')
            ORACLE_PLATFORM=SunOS gmake -C runtimes libs
            (cd "${path_to_runtime}" && tar xzf "${INSTANTCLIENT_ARCHIVE}")
            LD_LIBRARY_PATH="${path_to_runtime}:${LD_LIBRARY_PATH}"
            export LD_LIBRARY_PATH
            cargo test --test "*"
            ;;
        'AIX')
            ORACLE_PLATFORM=AIX /opt/freeware/bin/make -C runtimes libs
            (cd "${path_to_runtime}" && tar xzf "${INSTANTCLIENT_ARCHIVE}")
            LIBPATH="${path_to_runtime}:${LIBPATH}"
            export LIBPATH
            cargo test --test "*"
            ;;
        *)
            # 1. obtain rebundled client
            bazel build //omd/packages/oci:oci_light_lin_x64

            # 2. unzip to runtimes(simulates behavior of Agent/Bakery)
            # ATTENTION! Shell solution below is pure temporary: to be replaced with a pure bazel after consulting by Bazel team
            path_to_zip="$(bazel info bazel-bin)/omd/packages/oci/oci_light_lin_x64.zip"
            unzip -uoq "${path_to_zip}" -d "${path_to_runtime}"

            # 3. relink libaio
            libaio=$(ldconfig -p | grep libaio.so.1 | awk '{print $NF}')
            if [ -e "${libaio}" ]; then
                ln -sf "${libaio}" "${path_to_runtime}/libaio.so.1"
            else
                echo "libaio absent. Integration testing is not possible"
                exit 1
            fi

            export LD_LIBRARY_PATH="${path_to_runtime}:${LD_LIBRARY_PATH}"
            bazel test :mk-oracle-lib-test-external
            ;;
    esac
}

run_test_component_remote_host() {
    TEST_NAME="test_ora_sql_test"
    SSH_ARGS=
    [ -n "$SSH_KEYFILE" ] && SSH_ARGS="$SSH_ARGS -i $SSH_KEYFILE -o StrictHostKeyChecking=no"

    # copy Oracle DB plug-in test-binary to the remote-host and run the tests
    # shellcheck disable=SC2086
    scp $SSH_ARGS "${TEST_BINARY_LOCAL_PATH}" "${HOST_ADDRESS}":"${TEST_BINARY_REMOTE_PATH}"
    # shellcheck disable=SC2086,SC2087,SC2029
    ssh $SSH_ARGS "${HOST_ADDRESS}" <<EOF
        set -e
        cd "${TEST_BINARY_REMOTE_PATH}"
        export ORACLE_HOME="${ORACLE_HOME}"
        export CI_ORA2_DB_TEST="${CI_ORA2_DB_TEST}"
        export MK_CONFDIR="${TEST_BINARY_REMOTE_PATH}"
        export MK_LIBDIR="${TEST_BINARY_REMOTE_PATH}"/runtimes
        chmod +x ./"${TEST_NAME}"
        ./"${TEST_NAME}"
EOF
}

cleanup_docker_container() {
    local version="$1"
    local service

    # Map version to service name
    case ${version} in
        23) service="oracle-free" ;;
        11) service="oracle-xe" ;;
        12 | 12c) service="oracle-12c" ;;
        19 | 19c) service="oracle-19c" ;;
        *)
            echo "Warning: Unknown version '${version}' for cleanup"
            return 1
            ;;
    esac

    echo "Stopping Docker container for Oracle ${version}..."
    local docker_compose_file="${PWD}/tests/files/docker/docker-compose.yml"
    docker compose -f "${docker_compose_file}" down "${service}"
    echo "Container ${service} stopped successfully"
}

run_test_component_docker() {
    # Check if platform supports Docker tests before doing anything
    case "$(uname)" in
        'SunOS' | 'AIX')
            failure "Docker tests are not supported on $(uname)"
            ;;
    esac

    echo "Running component tests against Oracle ${ORACLE_DOCKER_VERSION} in Docker..."

    local run_db_script="${PWD}/tests/files/docker/run-db.sh"

    # Start the database
    if ! "${run_db_script}" -v "${ORACLE_DOCKER_VERSION}"; then
        failure "Failed to start Oracle ${ORACLE_DOCKER_VERSION} database container"
    fi

    # Determine SID based on version
    local db_sid
    local db_service_name
    case ${ORACLE_DOCKER_VERSION} in
        23) db_sid="FREE" db_service_name="FREE" ;;
        11) db_sid="XE" db_service_name="XE" ;;
        12 | 12c) db_sid="XE" db_service_name="xe.oracle.docker" ;;
        19 | 19c) db_sid="ORCLCDB" db_service_name="ORCLCDB" ;;
        *)
            cleanup_docker_container "${ORACLE_DOCKER_VERSION}"
            failure "Unsupported Oracle version: ${ORACLE_DOCKER_VERSION}"
            ;;
    esac

    # Set up test environment variables for Docker Oracle
    export CI_ORA2_DB_TEST="localhost:sys:oracle:1521:${db_sid}::${db_service_name}:_:_:"
    echo "CI_ORA2_DB_TEST set to: ${CI_ORA2_DB_TEST}"

    setup_tests

    # Run the tests and capture exit code
    local test_exit_code=0

    # 1. obtain rebundled client
    bazel build //omd/packages/oci:oci_light_lin_x64

    # 2. unzip to runtimes(simulates behavior of Agent/Bakery)
    # ATTENTION! Shell solution below is pure temporary: to be replaced with a pure bazel after consulting by Bazel team
    path_to_zip="$(bazel info bazel-bin)/omd/packages/oci/oci_light_lin_x64.zip"
    path_to_runtime="${PWD}/runtimes/plugins/packages/mk-oracle"
    unzip -uoq "${path_to_zip}" -d "${path_to_runtime}"

    # 3. relink libaio
    libaio=$(ldconfig -p | grep libaio.so.1 | awk '{print $NF}')
    if [ -e "${libaio}" ]; then
        ln -sf "${libaio}" "${path_to_runtime}/libaio.so.1"
    else
        cleanup_docker_container "${ORACLE_DOCKER_VERSION}"
        failure "libaio absent. Integration testing is not possible"
    fi

    export LD_LIBRARY_PATH="${path_to_runtime}:${LD_LIBRARY_PATH}"

    # Run tests and capture exit code
    if ! bazel test :mk-oracle-lib-test-external; then
        test_exit_code=$?
    fi

    # Always cleanup Docker container
    cleanup_docker_container "${ORACLE_DOCKER_VERSION}"

    # Exit with the test exit code
    if [ ${test_exit_code} -ne 0 ]; then
        failure "Component tests failed with exit code ${test_exit_code}"
    fi

    echo "Component tests completed successfully"
}

run_test_unit() {
    setup_tests

    case "$(uname)" in
        'SunOS' | 'AIX')
            cargo test --lib
            ;;
        *)
            bazel test :mk-oracle-lib-test-internal
            ;;
    esac
}

run_clippy() {
    case "$(uname)" in
        'SunOS')
            cargo clippy
            ;;
        'AIX')
            echo "clippy not available on AIX - skipping."
            ;;
        *)
            bazel build --config=clippy :all
            ;;
    esac
}

run_documentation() {
    case "$(uname)" in
        'SunOS' | 'AIX')
            cargo doc
            ;;
        *)
            bazel build :doc
            ;;
    esac
}

main() {
    # Change to the directory where this script resides, it makes many things easier
    # and we can call this script from everywhere.
    cd -- "${BASH_SOURCE%/*}"
    parse_options "$@"
    # TODO: Re-evaluate usage of --all-targets below
    test ${RUN_BUILD} = yes && run_build
    test ${RUN_UNIT_TESTS} = yes && run_test_unit
    test ${RUN_COMPONENT_TESTS} = yes && run_test_component
    test ${RUN_COMPONENT_TESTS_REMOTE_HOST} = yes && run_test_component_remote_host
    test ${RUN_DOCKER_TESTS} = yes && run_test_component_docker
    test ${RUN_CHECK_FORMAT} = yes && run_check_format
    test ${RUN_CLIPPY} = yes && run_clippy
    test ${RUN_FORMAT} = yes && run_format
    test ${RUN_DOCUMENTATION} = yes && run_documentation
    true
}

main "$@"
