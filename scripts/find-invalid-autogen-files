#!/bin/bash
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

# This script should find autogenerated files for which their is no corresponding source file available
# This is applicable for the workspaces on Jenkins, as there might exists autogenerated test files from previous runs
# which are not valid anymore for the current run and this causes a test to fail.

REPO_PATH="$(dirname "$(dirname "$(realpath "$0")")")"
cd "$REPO_PATH" || exit

AGENT_UNIT_DIR="$REPO_PATH/tests/agent-plugin-unit"
PY2_DIR="$AGENT_UNIT_DIR/py2"

source_test_files=$(find -L "$AGENT_UNIT_DIR" -maxdepth 1 -name "*.py" -printf "%f\n")
autogen_test_files=$(find -L "$PY2_DIR" -maxdepth 1 -name "*.py" -printf "%f\n")

for autogen_file in $autogen_test_files; do
    if [[ "$source_test_files" != *"$autogen_file"* ]]; then
        echo "No source file for $autogen_file found. Removing file from py2 dir."
        rm "$PY2_DIR/$autogen_file"
    fi
done
