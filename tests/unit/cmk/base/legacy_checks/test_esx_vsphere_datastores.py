#!/usr/bin/env python3
# Copyright (C) 2025 Checkmk GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

# mypy: disable-error-code="misc"
# mypy: disable-error-code="no-untyped-call"

from collections.abc import Mapping, Sequence
from typing import Any

import pytest

from cmk.agent_based.v1.type_defs import StringTable
from cmk.base.legacy_checks.esx_vsphere_datastores import (
    check_esx_vsphere_datastores,
    discover_esx_vsphere_datastores,
    parse_esx_vsphere_datastores,
)


@pytest.mark.parametrize(
    "string_table, expected_discoveries",
    [
        (
            [
                ["[backup_day_esx_blade_nfs_nfs32]"],
                ["accessible", "true"],
                ["capacity", "19923665018880"],
                ["freeSpace", "15224133410816"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/e430852e-b5e7cbe9"],
                ["[storage_iso]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/04cc2737-7d460e93"],
                ["[vmware_files]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/393e2076-21c41536"],
                ["[datastore01]"],
                ["accessible", "true"],
                ["capacity", "4500588855296"],
                ["freeSpace", "1684666318848"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/563b3611-f9333855-cfa1-00215e221152"],
                ["[system01_20100701]"],
                ["accessible", "true"],
                ["capacity", "492042190848"],
                ["freeSpace", "491020877824"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/56822303-d64ea045-c8cc-001a645a8f28"],
            ],
            [
                ("backup_day_esx_blade_nfs_nfs32", {}),
                ("datastore01", {}),
                ("storage_iso", {}),
                ("system01_20100701", {}),
                ("vmware_files", {}),
            ],
        ),
    ],
)
def test_discover_esx_vsphere_datastores(
    string_table: StringTable, expected_discoveries: Sequence[tuple[str, Mapping[str, Any]]]
) -> None:
    """Test discovery function for esx_vsphere_datastores check."""
    parsed = parse_esx_vsphere_datastores(string_table)
    result = list(discover_esx_vsphere_datastores(parsed))
    assert sorted(result) == sorted(expected_discoveries)


@pytest.mark.usefixtures("initialised_item_state")
@pytest.mark.parametrize(
    "item, params, string_table, expected_results",
    [
        (
            "backup_day_esx_blade_nfs_nfs32",
            {
                "levels": (80.0, 90.0),
                "magic_normsize": 20,
                "levels_low": (50.0, 60.0),
                "trend_range": 24,
                "trend_perfdata": True,
                "show_levels": "onmagic",
                "inodes_levels": (10.0, 5.0),
                "show_inodes": "onlow",
                "show_reserved": False,
            },
            [
                ["[backup_day_esx_blade_nfs_nfs32]"],
                ["accessible", "true"],
                ["capacity", "19923665018880"],
                ["freeSpace", "15224133410816"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/e430852e-b5e7cbe9"],
                ["[storage_iso]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/04cc2737-7d460e93"],
                ["[vmware_files]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/393e2076-21c41536"],
                ["[datastore01]"],
                ["accessible", "true"],
                ["capacity", "4500588855296"],
                ["freeSpace", "1684666318848"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/563b3611-f9333855-cfa1-00215e221152"],
                ["[system01_20100701]"],
                ["accessible", "true"],
                ["capacity", "492042190848"],
                ["freeSpace", "491020877824"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/56822303-d64ea045-c8cc-001a645a8f28"],
            ],
            [
                (
                    0,
                    "Used: 23.59% - 4.27 TiB of 18.1 TiB",
                    [
                        (
                            "fs_used",
                            4481822.59375,
                            15200550.09375,
                            17100618.85546875,
                            0.0,
                            19000687.6171875,
                        ),
                        ("fs_free", 14518865.0234375, None, None, 0.0, None),
                        ("fs_used_percent", 23.587686319814374, 80.0, 90.0, 0.0, 100.0),
                        ("fs_size", 19000687.6171875, None, None, 0.0, None),
                    ],
                ),
                (0, "Uncommitted: 0 B", [("uncommitted", 0.0)]),
                (0, "Provisioning: 23.59%", []),
                (0, "", [("overprovisioned", 4481822.59375)]),
            ],
        ),
        (
            "datastore01",
            {
                "levels": (80.0, 90.0),
                "magic_normsize": 20,
                "levels_low": (50.0, 60.0),
                "trend_range": 24,
                "trend_perfdata": True,
                "show_levels": "onmagic",
                "inodes_levels": (10.0, 5.0),
                "show_inodes": "onlow",
                "show_reserved": False,
            },
            [
                ["[backup_day_esx_blade_nfs_nfs32]"],
                ["accessible", "true"],
                ["capacity", "19923665018880"],
                ["freeSpace", "15224133410816"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/e430852e-b5e7cbe9"],
                ["[storage_iso]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/04cc2737-7d460e93"],
                ["[vmware_files]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/393e2076-21c41536"],
                ["[datastore01]"],
                ["accessible", "true"],
                ["capacity", "4500588855296"],
                ["freeSpace", "1684666318848"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/563b3611-f9333855-cfa1-00215e221152"],
                ["[system01_20100701]"],
                ["accessible", "true"],
                ["capacity", "492042190848"],
                ["freeSpace", "491020877824"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/56822303-d64ea045-c8cc-001a645a8f28"],
            ],
            [
                (
                    0,
                    "Used: 62.57% - 2.56 TiB of 4.09 TiB",
                    [
                        (
                            "fs_used",
                            2685473.0,
                            3433676.799999237,
                            3862886.3999996185,
                            0.0,
                            4292096.0,
                        ),
                        ("fs_free", 1606623.0, None, None, 0.0, None),
                        (
                            "fs_used_percent",
                            62.56786893862579,
                            79.99999999998222,
                            89.99999999999112,
                            0.0,
                            100.0,
                        ),
                        ("fs_size", 4292096.0, None, None, 0, None),
                    ],
                ),
                (0, "Uncommitted: 0 B", [("uncommitted", 0.0)]),
                (0, "Provisioning: 62.57%", []),
                (0, "", [("overprovisioned", 2685473.0)]),
            ],
        ),
        (
            "storage_iso",
            {
                "levels": (80.0, 90.0),
                "magic_normsize": 20,
                "levels_low": (50.0, 60.0),
                "trend_range": 24,
                "trend_perfdata": True,
                "show_levels": "onmagic",
                "inodes_levels": (10.0, 5.0),
                "show_inodes": "onlow",
                "show_reserved": False,
            },
            [
                ["[backup_day_esx_blade_nfs_nfs32]"],
                ["accessible", "true"],
                ["capacity", "19923665018880"],
                ["freeSpace", "15224133410816"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/e430852e-b5e7cbe9"],
                ["[storage_iso]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/04cc2737-7d460e93"],
                ["[vmware_files]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/393e2076-21c41536"],
                ["[datastore01]"],
                ["accessible", "true"],
                ["capacity", "4500588855296"],
                ["freeSpace", "1684666318848"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/563b3611-f9333855-cfa1-00215e221152"],
                ["[system01_20100701]"],
                ["accessible", "true"],
                ["capacity", "492042190848"],
                ["freeSpace", "491020877824"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/56822303-d64ea045-c8cc-001a645a8f28"],
            ],
            [
                (
                    0,
                    "Used: 76.68% - 5.49 TiB of 7.16 TiB",
                    [
                        (
                            "fs_used",
                            5754936.7265625,
                            6004113.7281246185,
                            6754627.944140434,
                            0.0,
                            7505142.16015625,
                        ),
                        ("fs_free", 1750205.43359375, None, None, 0.0, None),
                        (
                            "fs_used_percent",
                            76.67991629944937,
                            79.99999999999491,
                            89.99999999999746,
                            0.0,
                            100.0,
                        ),
                        ("fs_size", 7505142.16015625, None, None, 0, None),
                    ],
                ),
                (0, "Uncommitted: 0 B", [("uncommitted", 0.0)]),
                (0, "Provisioning: 76.68%", []),
                (0, "", [("overprovisioned", 5754936.7265625)]),
            ],
        ),
        (
            "system01_20100701",
            {
                "levels": (80.0, 90.0),
                "magic_normsize": 20,
                "levels_low": (50.0, 60.0),
                "trend_range": 24,
                "trend_perfdata": True,
                "show_levels": "onmagic",
                "inodes_levels": (10.0, 5.0),
                "show_inodes": "onlow",
                "show_reserved": False,
            },
            [
                ["[backup_day_esx_blade_nfs_nfs32]"],
                ["accessible", "true"],
                ["capacity", "19923665018880"],
                ["freeSpace", "15224133410816"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/e430852e-b5e7cbe9"],
                ["[storage_iso]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/04cc2737-7d460e93"],
                ["[vmware_files]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/393e2076-21c41536"],
                ["[datastore01]"],
                ["accessible", "true"],
                ["capacity", "4500588855296"],
                ["freeSpace", "1684666318848"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/563b3611-f9333855-cfa1-00215e221152"],
                ["[system01_20100701]"],
                ["accessible", "true"],
                ["capacity", "492042190848"],
                ["freeSpace", "491020877824"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/56822303-d64ea045-c8cc-001a645a8f28"],
            ],
            [
                (
                    0,
                    "Used: 0.21% - 974 MiB of 458 GiB",
                    [
                        ("fs_used", 974.0, 375398.39999961853, 422323.19999980927, 0.0, 469248.0),
                        ("fs_free", 468274.0, None, None, 0.0, None),
                        (
                            "fs_used_percent",
                            0.20756614839061646,
                            79.9999999999187,
                            89.99999999995936,
                            0.0,
                            100.0,
                        ),
                        ("fs_size", 469248.0, None, None, 0, None),
                    ],
                ),
                (0, "Uncommitted: 0 B", [("uncommitted", 0.0)]),
                (0, "Provisioning: 0.21%", []),
                (0, "", [("overprovisioned", 974.0)]),
            ],
        ),
        (
            "vmware_files",
            {
                "levels": (80.0, 90.0),
                "magic_normsize": 20,
                "levels_low": (50.0, 60.0),
                "trend_range": 24,
                "trend_perfdata": True,
                "show_levels": "onmagic",
                "inodes_levels": (10.0, 5.0),
                "show_inodes": "onlow",
                "show_reserved": False,
            },
            [
                ["[backup_day_esx_blade_nfs_nfs32]"],
                ["accessible", "true"],
                ["capacity", "19923665018880"],
                ["freeSpace", "15224133410816"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/e430852e-b5e7cbe9"],
                ["[storage_iso]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/04cc2737-7d460e93"],
                ["[vmware_files]"],
                ["accessible", "true"],
                ["capacity", "7869711945728"],
                ["freeSpace", "1835223412736"],
                ["type", "NFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/393e2076-21c41536"],
                ["[datastore01]"],
                ["accessible", "true"],
                ["capacity", "4500588855296"],
                ["freeSpace", "1684666318848"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/563b3611-f9333855-cfa1-00215e221152"],
                ["[system01_20100701]"],
                ["accessible", "true"],
                ["capacity", "492042190848"],
                ["freeSpace", "491020877824"],
                ["type", "VMFS"],
                ["uncommitted", "0"],
                ["url", "/vmfs/volumes/56822303-d64ea045-c8cc-001a645a8f28"],
            ],
            [
                (
                    0,
                    "Used: 76.68% - 5.49 TiB of 7.16 TiB",
                    [
                        (
                            "fs_used",
                            5754936.7265625,
                            6004113.7281246185,
                            6754627.944140434,
                            0.0,
                            7505142.16015625,
                        ),
                        ("fs_free", 1750205.43359375, None, None, 0.0, None),
                        (
                            "fs_used_percent",
                            76.67991629944937,
                            79.99999999999491,
                            89.99999999999746,
                            0.0,
                            100.0,
                        ),
                        ("fs_size", 7505142.16015625, None, None, 0, None),
                    ],
                ),
                (0, "Uncommitted: 0 B", [("uncommitted", 0.0)]),
                (0, "Provisioning: 76.68%", []),
                (0, "", [("overprovisioned", 5754936.7265625)]),
            ],
        ),
    ],
)
def test_check_esx_vsphere_datastores(
    item: str, params: Mapping[str, Any], string_table: StringTable, expected_results: Sequence[Any]
) -> None:
    """Test check function for esx_vsphere_datastores check."""
    parsed = parse_esx_vsphere_datastores(string_table)
    result = list(check_esx_vsphere_datastores(item, params, parsed))
    assert result == expected_results
