#!/usr/bin/env python3
# Copyright (C) 2025 Checkmk GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

# mypy: disable-error-code="no-untyped-call"

from collections.abc import Mapping, Sequence
from typing import Any

import pytest

from cmk.agent_based.v1.type_defs import StringTable
from cmk.base.legacy_checks.ibm_svc_disks import (
    check_ibm_svc_disks,
    discover_ibm_svc_disks,
    parse_ibm_svc_disks,
)


@pytest.mark.parametrize(
    "string_table, expected_discoveries",
    [
        (
            [
                [
                    "0",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7BRZ_mdisk08",
                    "4",
                    "1",
                    "24",
                    "",
                    "",
                ],
                [
                    "1",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7BRZ_mdisk08",
                    "3",
                    "1",
                    "23",
                    "",
                    "",
                ],
                [
                    "2",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7BRZ_mdisk08",
                    "2",
                    "1",
                    "22",
                    "",
                    "",
                ],
                [
                    "3",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7BRZ_mdisk08",
                    "1",
                    "1",
                    "21",
                    "",
                    "",
                ],
                [
                    "4",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7BRZ_mdisk08",
                    "0",
                    "1",
                    "20",
                    "",
                    "",
                ],
                [
                    "5",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "8",
                    "V7BRZ_mdisk09",
                    "4",
                    "5",
                    "4",
                    "",
                    "",
                ],
                [
                    "6",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "6",
                    "1",
                    "18",
                    "",
                    "",
                ],
                [
                    "7",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "5",
                    "1",
                    "17",
                    "",
                    "",
                ],
                [
                    "8",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "4",
                    "1",
                    "16",
                    "",
                    "",
                ],
                [
                    "9",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "3",
                    "1",
                    "15",
                    "",
                    "",
                ],
                [
                    "10",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "2",
                    "1",
                    "14",
                    "",
                    "",
                ],
                [
                    "11",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "1",
                    "1",
                    "13",
                    "",
                    "",
                ],
                [
                    "12",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "0",
                    "1",
                    "12",
                    "",
                    "",
                ],
                [
                    "13",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "6",
                    "1",
                    "10",
                    "",
                    "",
                ],
                [
                    "14",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "7",
                    "1",
                    "11",
                    "",
                    "",
                ],
                [
                    "15",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "5",
                    "1",
                    "9",
                    "",
                    "",
                ],
                [
                    "16",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "3",
                    "1",
                    "7",
                    "",
                    "",
                ],
                [
                    "17",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "4",
                    "1",
                    "8",
                    "",
                    "",
                ],
                [
                    "18",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "2",
                    "1",
                    "6",
                    "",
                    "",
                ],
                [
                    "19",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "1",
                    "1",
                    "5",
                    "",
                    "",
                ],
                [
                    "20",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7RZ_mdisk8",
                    "4",
                    "1",
                    "24",
                    "",
                    "",
                    "inactive",
                ],
                [
                    "21",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7RZ_mdisk8",
                    "3",
                    "1",
                    "23",
                    "",
                    "",
                    "inactive",
                ],
            ],
            [(None, {})],
        ),
    ],
)
def test_discover_ibm_svc_disks(
    string_table: StringTable, expected_discoveries: Sequence[tuple[str | None, Mapping[str, Any]]]
) -> None:
    """Test discovery function for ibm_svc_disks check."""
    parsed = parse_ibm_svc_disks(string_table)
    result = list(discover_ibm_svc_disks(parsed))
    assert sorted(result) == sorted(expected_discoveries)


@pytest.mark.parametrize(
    "item, params, string_table, expected_results",
    [
        (
            None,
            {"failed_spare_ratio": (1.0, 50.0), "offline_spare_ratio": (1.0, 50.0)},
            [
                [
                    "0",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7BRZ_mdisk08",
                    "4",
                    "1",
                    "24",
                    "",
                    "",
                ],
                [
                    "1",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7BRZ_mdisk08",
                    "3",
                    "1",
                    "23",
                    "",
                    "",
                ],
                [
                    "2",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7BRZ_mdisk08",
                    "2",
                    "1",
                    "22",
                    "",
                    "",
                ],
                [
                    "3",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7BRZ_mdisk08",
                    "1",
                    "1",
                    "21",
                    "",
                    "",
                ],
                [
                    "4",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7BRZ_mdisk08",
                    "0",
                    "1",
                    "20",
                    "",
                    "",
                ],
                [
                    "5",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "8",
                    "V7BRZ_mdisk09",
                    "4",
                    "5",
                    "4",
                    "",
                    "",
                ],
                [
                    "6",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "6",
                    "1",
                    "18",
                    "",
                    "",
                ],
                [
                    "7",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "5",
                    "1",
                    "17",
                    "",
                    "",
                ],
                [
                    "8",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "4",
                    "1",
                    "16",
                    "",
                    "",
                ],
                [
                    "9",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "3",
                    "1",
                    "15",
                    "",
                    "",
                ],
                [
                    "10",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "2",
                    "1",
                    "14",
                    "",
                    "",
                ],
                [
                    "11",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "1",
                    "1",
                    "13",
                    "",
                    "",
                ],
                [
                    "12",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "1",
                    "V7BRZ_mdisk02",
                    "0",
                    "1",
                    "12",
                    "",
                    "",
                ],
                [
                    "13",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "6",
                    "1",
                    "10",
                    "",
                    "",
                ],
                [
                    "14",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "7",
                    "1",
                    "11",
                    "",
                    "",
                ],
                [
                    "15",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "5",
                    "1",
                    "9",
                    "",
                    "",
                ],
                [
                    "16",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "3",
                    "1",
                    "7",
                    "",
                    "",
                ],
                [
                    "17",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "4",
                    "1",
                    "8",
                    "",
                    "",
                ],
                [
                    "18",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "2",
                    "1",
                    "6",
                    "",
                    "",
                ],
                [
                    "19",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "16",
                    "V7BRZ_mdisk19",
                    "1",
                    "1",
                    "5",
                    "",
                    "",
                ],
                [
                    "20",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7RZ_mdisk8",
                    "4",
                    "1",
                    "24",
                    "",
                    "",
                    "inactive",
                ],
                [
                    "21",
                    "online",
                    "",
                    "member",
                    "sas_hdd",
                    "558.4GB",
                    "7",
                    "V7RZ_mdisk8",
                    "3",
                    "1",
                    "23",
                    "",
                    "",
                    "inactive",
                ],
            ],
            [
                (0, "Total raw capacity: 13.2 TB", [("total_disk_capacity", 13190703559475.195)]),
                (0, "Total disks: 22", [("total_disks", 22)]),
                (0, "Spare disks: 0", [("spare_disks", 0)]),
                (0, "Failed disks: 0", [("failed_disks", 0)]),
            ],
        ),
    ],
)
def test_check_ibm_svc_disks(
    item: str, params: Mapping[str, Any], string_table: StringTable, expected_results: Sequence[Any]
) -> None:
    """Test check function for ibm_svc_disks check."""
    parsed = parse_ibm_svc_disks(string_table)
    result = list(check_ibm_svc_disks(item, params, parsed))
    assert result == expected_results
