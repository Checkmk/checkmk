#!/usr/bin/env python3
# Copyright (C) 2025 Checkmk GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

# mypy: disable-error-code="misc"
# mypy: disable-error-code="no-untyped-call"

from collections.abc import Mapping, Sequence
from typing import Any

import pytest

from cmk.agent_based.v2 import StringTable
from cmk.base.legacy_checks.openhardwaremonitor import (
    check_openhardwaremonitor_clock,
    discover_openhardwaremonitor,
    parse_openhardwaremonitor,
)


@pytest.mark.parametrize(
    "string_table, expected_discoveries",
    [
        (
            [
                ["Index", "Name", "Parent", "SensorType", "Value"],
                ["0", "Temperature", "/hdd/0", "Temperature", "28.000000"],
                ["0", "System Fan", "/lpc/w83627dhgp", "Fan", "1506.696411"],
                ["1", "CPU Fan", "/lpc/w83627dhgp", "Fan", "2518.656738"],
                ["1", "CPU Cores", "/intelcpu/0", "Power", "1.651155"],
                ["0", "CPU Core #1", "/intelcpu/0", "Temperature", "28.000000"],
                ["0", "Remaining Life", "/hdd/0", "Level", "98.000000"],
                ["1", "CPU Core #1", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "CPU Core #1", "/intelcpu/0", "Load", "12.307692"],
                ["2", "CPU Core #2", "/intelcpu/0", "Clock", "1297.013062"],
                ["0", "Memory", "/ram", "Load", "61.928921"],
                ["2", "CPU Graphics", "/intelcpu/0", "Power", "0.040867"],
                ["1", "CPU Core #2", "/intelcpu/0", "Temperature", "29.000000"],
                ["3", "CPU DRAM", "/intelcpu/0", "Power", "1.188020"],
                ["2", "CPU Core #3", "/intelcpu/0", "Temperature", "31.000000"],
                ["1", "Host Writes to Controller", "/hdd/0", "Data", "1589.000000"],
                ["2", "Host Reads", "/hdd/0", "Data", "1366.000000"],
                ["4", "CPU Core #4", "/intelcpu/0", "Load", "6.153846"],
                ["3", "CPU Core #3", "/intelcpu/0", "Clock", "1297.013062"],
                ["3", "CPU Core #3", "/intelcpu/0", "Load", "18.461536"],
                ["4", "CPU Core #4", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "Available Memory", "/ram", "Data", "3.011536"],
                ["2", "CPU Core #2", "/intelcpu/0", "Load", "15.384615"],
                ["0", "Controller Writes to NAND", "/hdd/0", "Data", "3371.000000"],
                ["1", "Write Amplification", "/hdd/0", "Factor", "2.121460"],
                ["0", "CPU Total", "/intelcpu/0", "Load", "13.076920"],
                ["0", "Bus Speed", "/intelcpu/0", "Clock", "99.770233"],
                ["0", "Used Memory", "/ram", "Data", "4.898762"],
                ["3", "CPU Core #4", "/intelcpu/0", "Temperature", "27.000000"],
                ["4", "CPU Package", "/intelcpu/0", "Temperature", "31.000000"],
                ["0", "Used Space", "/hdd/0", "Load", "72.429222"],
            ],
            [
                ("cpu0 Bus Speed", {}),
                ("cpu0 Core #1", {}),
                ("cpu0 Core #2", {}),
                ("cpu0 Core #3", {}),
                ("cpu0 Core #4", {}),
            ],
        ),
    ],
)
def test_discover_openhardwaremonitor(
    string_table: StringTable, expected_discoveries: Sequence[tuple[str, Mapping[str, Any]]]
) -> None:
    """Test discovery function for openhardwaremonitor check."""
    parsed = parse_openhardwaremonitor(string_table)
    result = list(discover_openhardwaremonitor(parsed))
    assert sorted(result) == sorted(expected_discoveries)


@pytest.mark.parametrize(
    "item, params, string_table, expected_results",
    [
        (
            "cpu0 Bus Speed",
            {},
            [
                ["Index", "Name", "Parent", "SensorType", "Value"],
                ["0", "Temperature", "/hdd/0", "Temperature", "28.000000"],
                ["0", "System Fan", "/lpc/w83627dhgp", "Fan", "1506.696411"],
                ["1", "CPU Fan", "/lpc/w83627dhgp", "Fan", "2518.656738"],
                ["1", "CPU Cores", "/intelcpu/0", "Power", "1.651155"],
                ["0", "CPU Core #1", "/intelcpu/0", "Temperature", "28.000000"],
                ["0", "Remaining Life", "/hdd/0", "Level", "98.000000"],
                ["1", "CPU Core #1", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "CPU Core #1", "/intelcpu/0", "Load", "12.307692"],
                ["2", "CPU Core #2", "/intelcpu/0", "Clock", "1297.013062"],
                ["0", "Memory", "/ram", "Load", "61.928921"],
                ["2", "CPU Graphics", "/intelcpu/0", "Power", "0.040867"],
                ["1", "CPU Core #2", "/intelcpu/0", "Temperature", "29.000000"],
                ["3", "CPU DRAM", "/intelcpu/0", "Power", "1.188020"],
                ["2", "CPU Core #3", "/intelcpu/0", "Temperature", "31.000000"],
                ["1", "Host Writes to Controller", "/hdd/0", "Data", "1589.000000"],
                ["2", "Host Reads", "/hdd/0", "Data", "1366.000000"],
                ["4", "CPU Core #4", "/intelcpu/0", "Load", "6.153846"],
                ["3", "CPU Core #3", "/intelcpu/0", "Clock", "1297.013062"],
                ["3", "CPU Core #3", "/intelcpu/0", "Load", "18.461536"],
                ["4", "CPU Core #4", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "Available Memory", "/ram", "Data", "3.011536"],
                ["2", "CPU Core #2", "/intelcpu/0", "Load", "15.384615"],
                ["0", "Controller Writes to NAND", "/hdd/0", "Data", "3371.000000"],
                ["1", "Write Amplification", "/hdd/0", "Factor", "2.121460"],
                ["0", "CPU Total", "/intelcpu/0", "Load", "13.076920"],
                ["0", "Bus Speed", "/intelcpu/0", "Clock", "99.770233"],
                ["0", "Used Memory", "/ram", "Data", "4.898762"],
                ["3", "CPU Core #4", "/intelcpu/0", "Temperature", "27.000000"],
                ["4", "CPU Package", "/intelcpu/0", "Temperature", "31.000000"],
                ["0", "Used Space", "/hdd/0", "Load", "72.429222"],
            ],
            [0, "99.8 MHz", [("clock", 99.770233)]],
        ),
        (
            "cpu0 Core #1",
            {},
            [
                ["Index", "Name", "Parent", "SensorType", "Value"],
                ["0", "Temperature", "/hdd/0", "Temperature", "28.000000"],
                ["0", "System Fan", "/lpc/w83627dhgp", "Fan", "1506.696411"],
                ["1", "CPU Fan", "/lpc/w83627dhgp", "Fan", "2518.656738"],
                ["1", "CPU Cores", "/intelcpu/0", "Power", "1.651155"],
                ["0", "CPU Core #1", "/intelcpu/0", "Temperature", "28.000000"],
                ["0", "Remaining Life", "/hdd/0", "Level", "98.000000"],
                ["1", "CPU Core #1", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "CPU Core #1", "/intelcpu/0", "Load", "12.307692"],
                ["2", "CPU Core #2", "/intelcpu/0", "Clock", "1297.013062"],
                ["0", "Memory", "/ram", "Load", "61.928921"],
                ["2", "CPU Graphics", "/intelcpu/0", "Power", "0.040867"],
                ["1", "CPU Core #2", "/intelcpu/0", "Temperature", "29.000000"],
                ["3", "CPU DRAM", "/intelcpu/0", "Power", "1.188020"],
                ["2", "CPU Core #3", "/intelcpu/0", "Temperature", "31.000000"],
                ["1", "Host Writes to Controller", "/hdd/0", "Data", "1589.000000"],
                ["2", "Host Reads", "/hdd/0", "Data", "1366.000000"],
                ["4", "CPU Core #4", "/intelcpu/0", "Load", "6.153846"],
                ["3", "CPU Core #3", "/intelcpu/0", "Clock", "1297.013062"],
                ["3", "CPU Core #3", "/intelcpu/0", "Load", "18.461536"],
                ["4", "CPU Core #4", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "Available Memory", "/ram", "Data", "3.011536"],
                ["2", "CPU Core #2", "/intelcpu/0", "Load", "15.384615"],
                ["0", "Controller Writes to NAND", "/hdd/0", "Data", "3371.000000"],
                ["1", "Write Amplification", "/hdd/0", "Factor", "2.121460"],
                ["0", "CPU Total", "/intelcpu/0", "Load", "13.076920"],
                ["0", "Bus Speed", "/intelcpu/0", "Clock", "99.770233"],
                ["0", "Used Memory", "/ram", "Data", "4.898762"],
                ["3", "CPU Core #4", "/intelcpu/0", "Temperature", "27.000000"],
                ["4", "CPU Package", "/intelcpu/0", "Temperature", "31.000000"],
                ["0", "Used Space", "/hdd/0", "Load", "72.429222"],
            ],
            [0, "1297.0 MHz", [("clock", 1297.013062)]],
        ),
        (
            "cpu0 Core #2",
            {},
            [
                ["Index", "Name", "Parent", "SensorType", "Value"],
                ["0", "Temperature", "/hdd/0", "Temperature", "28.000000"],
                ["0", "System Fan", "/lpc/w83627dhgp", "Fan", "1506.696411"],
                ["1", "CPU Fan", "/lpc/w83627dhgp", "Fan", "2518.656738"],
                ["1", "CPU Cores", "/intelcpu/0", "Power", "1.651155"],
                ["0", "CPU Core #1", "/intelcpu/0", "Temperature", "28.000000"],
                ["0", "Remaining Life", "/hdd/0", "Level", "98.000000"],
                ["1", "CPU Core #1", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "CPU Core #1", "/intelcpu/0", "Load", "12.307692"],
                ["2", "CPU Core #2", "/intelcpu/0", "Clock", "1297.013062"],
                ["0", "Memory", "/ram", "Load", "61.928921"],
                ["2", "CPU Graphics", "/intelcpu/0", "Power", "0.040867"],
                ["1", "CPU Core #2", "/intelcpu/0", "Temperature", "29.000000"],
                ["3", "CPU DRAM", "/intelcpu/0", "Power", "1.188020"],
                ["2", "CPU Core #3", "/intelcpu/0", "Temperature", "31.000000"],
                ["1", "Host Writes to Controller", "/hdd/0", "Data", "1589.000000"],
                ["2", "Host Reads", "/hdd/0", "Data", "1366.000000"],
                ["4", "CPU Core #4", "/intelcpu/0", "Load", "6.153846"],
                ["3", "CPU Core #3", "/intelcpu/0", "Clock", "1297.013062"],
                ["3", "CPU Core #3", "/intelcpu/0", "Load", "18.461536"],
                ["4", "CPU Core #4", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "Available Memory", "/ram", "Data", "3.011536"],
                ["2", "CPU Core #2", "/intelcpu/0", "Load", "15.384615"],
                ["0", "Controller Writes to NAND", "/hdd/0", "Data", "3371.000000"],
                ["1", "Write Amplification", "/hdd/0", "Factor", "2.121460"],
                ["0", "CPU Total", "/intelcpu/0", "Load", "13.076920"],
                ["0", "Bus Speed", "/intelcpu/0", "Clock", "99.770233"],
                ["0", "Used Memory", "/ram", "Data", "4.898762"],
                ["3", "CPU Core #4", "/intelcpu/0", "Temperature", "27.000000"],
                ["4", "CPU Package", "/intelcpu/0", "Temperature", "31.000000"],
                ["0", "Used Space", "/hdd/0", "Load", "72.429222"],
            ],
            [0, "1297.0 MHz", [("clock", 1297.013062)]],
        ),
        (
            "cpu0 Core #3",
            {},
            [
                ["Index", "Name", "Parent", "SensorType", "Value"],
                ["0", "Temperature", "/hdd/0", "Temperature", "28.000000"],
                ["0", "System Fan", "/lpc/w83627dhgp", "Fan", "1506.696411"],
                ["1", "CPU Fan", "/lpc/w83627dhgp", "Fan", "2518.656738"],
                ["1", "CPU Cores", "/intelcpu/0", "Power", "1.651155"],
                ["0", "CPU Core #1", "/intelcpu/0", "Temperature", "28.000000"],
                ["0", "Remaining Life", "/hdd/0", "Level", "98.000000"],
                ["1", "CPU Core #1", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "CPU Core #1", "/intelcpu/0", "Load", "12.307692"],
                ["2", "CPU Core #2", "/intelcpu/0", "Clock", "1297.013062"],
                ["0", "Memory", "/ram", "Load", "61.928921"],
                ["2", "CPU Graphics", "/intelcpu/0", "Power", "0.040867"],
                ["1", "CPU Core #2", "/intelcpu/0", "Temperature", "29.000000"],
                ["3", "CPU DRAM", "/intelcpu/0", "Power", "1.188020"],
                ["2", "CPU Core #3", "/intelcpu/0", "Temperature", "31.000000"],
                ["1", "Host Writes to Controller", "/hdd/0", "Data", "1589.000000"],
                ["2", "Host Reads", "/hdd/0", "Data", "1366.000000"],
                ["4", "CPU Core #4", "/intelcpu/0", "Load", "6.153846"],
                ["3", "CPU Core #3", "/intelcpu/0", "Clock", "1297.013062"],
                ["3", "CPU Core #3", "/intelcpu/0", "Load", "18.461536"],
                ["4", "CPU Core #4", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "Available Memory", "/ram", "Data", "3.011536"],
                ["2", "CPU Core #2", "/intelcpu/0", "Load", "15.384615"],
                ["0", "Controller Writes to NAND", "/hdd/0", "Data", "3371.000000"],
                ["1", "Write Amplification", "/hdd/0", "Factor", "2.121460"],
                ["0", "CPU Total", "/intelcpu/0", "Load", "13.076920"],
                ["0", "Bus Speed", "/intelcpu/0", "Clock", "99.770233"],
                ["0", "Used Memory", "/ram", "Data", "4.898762"],
                ["3", "CPU Core #4", "/intelcpu/0", "Temperature", "27.000000"],
                ["4", "CPU Package", "/intelcpu/0", "Temperature", "31.000000"],
                ["0", "Used Space", "/hdd/0", "Load", "72.429222"],
            ],
            [0, "1297.0 MHz", [("clock", 1297.013062)]],
        ),
        (
            "cpu0 Core #4",
            {},
            [
                ["Index", "Name", "Parent", "SensorType", "Value"],
                ["0", "Temperature", "/hdd/0", "Temperature", "28.000000"],
                ["0", "System Fan", "/lpc/w83627dhgp", "Fan", "1506.696411"],
                ["1", "CPU Fan", "/lpc/w83627dhgp", "Fan", "2518.656738"],
                ["1", "CPU Cores", "/intelcpu/0", "Power", "1.651155"],
                ["0", "CPU Core #1", "/intelcpu/0", "Temperature", "28.000000"],
                ["0", "Remaining Life", "/hdd/0", "Level", "98.000000"],
                ["1", "CPU Core #1", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "CPU Core #1", "/intelcpu/0", "Load", "12.307692"],
                ["2", "CPU Core #2", "/intelcpu/0", "Clock", "1297.013062"],
                ["0", "Memory", "/ram", "Load", "61.928921"],
                ["2", "CPU Graphics", "/intelcpu/0", "Power", "0.040867"],
                ["1", "CPU Core #2", "/intelcpu/0", "Temperature", "29.000000"],
                ["3", "CPU DRAM", "/intelcpu/0", "Power", "1.188020"],
                ["2", "CPU Core #3", "/intelcpu/0", "Temperature", "31.000000"],
                ["1", "Host Writes to Controller", "/hdd/0", "Data", "1589.000000"],
                ["2", "Host Reads", "/hdd/0", "Data", "1366.000000"],
                ["4", "CPU Core #4", "/intelcpu/0", "Load", "6.153846"],
                ["3", "CPU Core #3", "/intelcpu/0", "Clock", "1297.013062"],
                ["3", "CPU Core #3", "/intelcpu/0", "Load", "18.461536"],
                ["4", "CPU Core #4", "/intelcpu/0", "Clock", "1297.013062"],
                ["1", "Available Memory", "/ram", "Data", "3.011536"],
                ["2", "CPU Core #2", "/intelcpu/0", "Load", "15.384615"],
                ["0", "Controller Writes to NAND", "/hdd/0", "Data", "3371.000000"],
                ["1", "Write Amplification", "/hdd/0", "Factor", "2.121460"],
                ["0", "CPU Total", "/intelcpu/0", "Load", "13.076920"],
                ["0", "Bus Speed", "/intelcpu/0", "Clock", "99.770233"],
                ["0", "Used Memory", "/ram", "Data", "4.898762"],
                ["3", "CPU Core #4", "/intelcpu/0", "Temperature", "27.000000"],
                ["4", "CPU Package", "/intelcpu/0", "Temperature", "31.000000"],
                ["0", "Used Space", "/hdd/0", "Load", "72.429222"],
            ],
            [0, "1297.0 MHz", [("clock", 1297.013062)]],
        ),
    ],
)
def test_check_openhardwaremonitor(
    item: str, params: Mapping[str, Any], string_table: StringTable, expected_results: Sequence[Any]
) -> None:
    """Test check function for openhardwaremonitor check."""
    parsed = parse_openhardwaremonitor(string_table)
    result = list(check_openhardwaremonitor_clock(item, params, parsed))
    assert result == expected_results
