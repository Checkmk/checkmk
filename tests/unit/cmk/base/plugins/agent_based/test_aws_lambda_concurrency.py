#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.
from typing import Optional

import pytest

from cmk.base.plugins.agent_based.agent_based_api.v1 import Metric, Result, Service, State
from cmk.base.plugins.agent_based.agent_based_api.v1.type_defs import CheckResult, DiscoveryResult
from cmk.base.plugins.agent_based.aws_lambda_concurrency import (
    _DEFAULT_PARAMETERS,
    check_aws_lambda_concurrency,
    discover_aws_lambda_concurrency,
    LambdaCloudwatchSection,
    parse_aws_lambda_provisioned_concurrency,
    SectionProvisionedConcurrencyAliases,
)
from cmk.base.plugins.agent_based.aws_lambda_performance import parse_aws_lambda
from cmk.base.plugins.agent_based.aws_lambda_summary import parse_aws_lambda_region_limits
from cmk.base.plugins.agent_based.utils.aws import (
    LambdaCloudwatchMetrics,
    LambdaRegionLimitsSection,
)

_STRING_TABLE_AWS_LAMBDA_PROVISIONED_CONCURRENCY = [
    [
        '{"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently":',
        '[{"FunctionArn":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"RequestedProvisionedConcurrentExecutions":',
        "2,",
        '"AvailableProvisionedConcurrentExecutions":',
        "2,",
        '"AllocatedProvisionedConcurrentExecutions":',
        "2,",
        '"Status":',
        '"READY",',
        '"LastModified":',
        '"2021-07-15T16:14:53+0000"}],',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function":',
        '[{"FunctionArn":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"RequestedProvisionedConcurrentExecutions":',
        "1,",
        '"AvailableProvisionedConcurrentExecutions":',
        "1,",
        '"AllocatedProvisionedConcurrentExecutions":',
        "1,",
        '"Status":',
        '"READY",',
        '"LastModified":',
        '"2021-07-16T08:19:04+0000"}]}',
    ]
]

# this is the metric data when a lambda function is not used in the last monitoring interval
_STRING_TABLE_AWS_LAMBDA_NOT_USED = [
    [
        '[{"Id":',
        '"id_0_ConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DeadLetterErrors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DestinationDeliveryFailures",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Duration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Errors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Invocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_IteratorAge",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_PostRuntimeExtensionsDuration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencySpilloverInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyUtilization",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Throttles",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_UnreservedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"}]',
    ],
    [
        '[{"Id":',
        '"id_0_ConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DeadLetterErrors",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DestinationDeliveryFailures",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Duration",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Errors",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Invocations",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_IteratorAge",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_PostRuntimeExtensionsDuration",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencySpilloverInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyUtilization",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Throttles",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_UnreservedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"}]',
    ],
]

# this is the metric data for concurrent invocations of my_python_test_function without concurrency metrics
_STRING_TABLE_AWS_LAMBDA_WITHOUT_CONCURRENCY = [
    [
        '[{"Id":',
        '"id_0_ConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DeadLetterErrors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DestinationDeliveryFailures",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Duration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-08 10:55:00+00:00"],',
        '"Values":',
        "[[902.3766666666667, null]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Errors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-08 10:55:00+00:00"],',
        '"Values":',
        "[[0.0, 600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Invocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-08 10:55:00+00:00"],',
        '"Values":',
        "[[3.0, 600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_IteratorAge",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_PostRuntimeExtensionsDuration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencySpilloverInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyUtilization",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Throttles",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-08 10:55:00+00:00"],',
        '"Values":',
        "[[0.0, 600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_UnreservedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"}]',
    ],
    [
        '[{"Id":',
        '"id_0_ConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DeadLetterErrors",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DestinationDeliveryFailures",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Duration",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Errors",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Invocations",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_IteratorAge",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_PostRuntimeExtensionsDuration",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencySpilloverInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyUtilization",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Throttles",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_UnreservedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"}]',
    ],
]

# this is the metric data for concurrent invocations of my_python_test_function with provisioned concurrency metrics
_STRING_TABLE_AWS_LAMBDA_CONCURRENCY = [
    [
        '[{"Id":',
        '"id_0_ConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DeadLetterErrors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DestinationDeliveryFailures",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Duration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Errors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Invocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_IteratorAge",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_PostRuntimeExtensionsDuration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencySpilloverInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyUtilization",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Throttles",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_UnreservedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently:provisioned_alias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_ConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[1.0, null]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_DeadLetterErrors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_DestinationDeliveryFailures",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_Duration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[4973.39,",
        "null]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_Errors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[0.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_Invocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[1.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_IteratorAge",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_PostRuntimeExtensionsDuration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_ProvisionedConcurrencyInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_ProvisionedConcurrencySpilloverInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_ProvisionedConcurrencyUtilization",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_ProvisionedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_Throttles",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[0.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_1_UnreservedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:calling_other_lambda_concurrently",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_ConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[2.0, null]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_DeadLetterErrors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_DestinationDeliveryFailures",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_Duration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[0.9190000000000002,",
        "null]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_Errors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[0.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_Invocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[10.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_IteratorAge",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_PostRuntimeExtensionsDuration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_ProvisionedConcurrencyInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[10.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_ProvisionedConcurrencySpilloverInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[1.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_ProvisionedConcurrencyUtilization",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[1.0,",
        "null]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_ProvisionedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[10.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_Throttles",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[0.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_2_UnreservedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function:ProvisionedAlias",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[1.0, null]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_ConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[10.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_DeadLetterErrors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_DestinationDeliveryFailures",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_Duration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[0.9190000000000002,",
        "null]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_Errors",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[0.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_Invocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[10.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_IteratorAge",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_PostRuntimeExtensionsDuration",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_ProvisionedConcurrencyInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[10.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_ProvisionedConcurrencySpilloverInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[0.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_ProvisionedConcurrencyUtilization",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_ProvisionedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[10.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_Throttles",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        '["2021-07-16',
        '15:32:00+00:00"],',
        '"Values":',
        "[[0.0,",
        "600]],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_3_UnreservedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-central-1:710145618630:function:my_python_test_function",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"}]',
    ],
    [
        '[{"Id":',
        '"id_0_ConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DeadLetterErrors",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_DestinationDeliveryFailures",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Duration",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Errors",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Invocations",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_IteratorAge",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_PostRuntimeExtensionsDuration",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencySpilloverInvocations",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrencyUtilization",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_ProvisionedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_Throttles",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"},',
        '{"Id":',
        '"id_0_UnreservedConcurrentExecutions",',
        '"Label":',
        '"arn:aws:lambda:eu-north-1:710145618630:function:myLambdaTestFunction",',
        '"Timestamps":',
        "[],",
        '"Values":',
        "[],",
        '"StatusCode":',
        '"Complete"}]',
    ],
]

_STRING_TABLE_AWS_LAMBDA_REGION_LIMITS_NOT_AVAILABLE = None
_STRING_TABLE_AWS_LAMBDA_REGION_LIMITS = [
    [
        '[["total_code_size",',
        '"Total',
        "Code",
        'Size",',
        "100,",
        "80530636800,",
        '"eu-central-1"],',
        '["concurrent_executions",',
        '"Concurrent',
        'Executions",',
        "100,",
        "1000,",
        '"eu-central-1"],',
        '["unreserved_concurrent_executions",',
        '"Unreserved',
        "Concurrent",
        'Executions",',
        "100,",
        "995,",
        '"eu-central-1"]]',
    ],
    [
        '[["total_code_size",',
        '"Total',
        "Code",
        'Size",',
        "100,",
        "80530636800,",
        '"eu-west-1"],',
        '["concurrent_executions",',
        '"Concurrent',
        'Executions",',
        "100,",
        "1000,",
        '"eu-west-1"],',
        '["unreserved_concurrent_executions",',
        '"Unreserved',
        "Concurrent",
        'Executions",',
        "100,",
        "1000,",
        '"eu-west-1"]]',
    ],
]

_PARAMETERS_WITH_ABSOLUTE_LEVELS = dict(_DEFAULT_PARAMETERS)
_PARAMETERS_WITH_ABSOLUTE_LEVELS["levels_concurrent_executions_absolute"] = (1.0, 2.0)
_PARAMETERS_WITH_ABSOLUTE_LEVELS["levels_unreserved_concurrent_executions_absolute"] = (1.0, 2.0)


@pytest.mark.parametrize(
    "item, params, string_table_aws_lambda_provisioned_concurrency, string_table_aws_lambda, string_table_aws_lambda_region_limits, results",
    [
        (
            "eu-central-1 my_python_test_function ProvisionedAlias",
            _DEFAULT_PARAMETERS,
            _STRING_TABLE_AWS_LAMBDA_PROVISIONED_CONCURRENCY,
            _STRING_TABLE_AWS_LAMBDA_NOT_USED,
            _STRING_TABLE_AWS_LAMBDA_REGION_LIMITS_NOT_AVAILABLE,
            [
                Result(state=State.OK, summary="Concurrent executions in percent: 0%"),
                Metric("aws_lambda_concurrent_executions_in_percent", 0.0),
            ],
        ),
        (
            "eu-central-1 my_python_test_function ProvisionedAlias",
            _DEFAULT_PARAMETERS,
            _STRING_TABLE_AWS_LAMBDA_PROVISIONED_CONCURRENCY,
            _STRING_TABLE_AWS_LAMBDA_WITHOUT_CONCURRENCY,
            _STRING_TABLE_AWS_LAMBDA_REGION_LIMITS_NOT_AVAILABLE,
            [
                Result(state=State.OK, summary="Concurrent executions in percent: 0%"),
                Metric("aws_lambda_concurrent_executions_in_percent", 0.0),
            ],
        ),
        (
            "eu-central-1 my_python_test_function ProvisionedAlias",
            _DEFAULT_PARAMETERS,
            _STRING_TABLE_AWS_LAMBDA_PROVISIONED_CONCURRENCY,
            _STRING_TABLE_AWS_LAMBDA_CONCURRENCY,
            _STRING_TABLE_AWS_LAMBDA_REGION_LIMITS_NOT_AVAILABLE,
            [
                Result(state=State.OK, summary="provisioned concurrent executions: 0.0167/s"),
                Metric("aws_lambda_provisioned_concurrency_executions", 0.016666666666666666),
                Result(state=State.OK, summary="provisioned concurrency invocations: 0.0167/s"),
                Metric("aws_lambda_provisioned_concurrency_invocations", 0.016666666666666666),
                Result(
                    state=State.CRIT,
                    summary="provisioned concurrency spillover invocations: 0.0017/s (warn/crit at 0.0003/s/0.0003/s)",
                ),
                Metric(
                    "aws_lambda_provisioned_concurrency_spillover_invocations",
                    0.0016666666666666668,
                    levels=(0.00028, 0.00028),
                ),
                Result(
                    state=State.CRIT,
                    summary="provisioned concurrency utilization: 100.00% (warn/crit at 90.00%/95.00%)",
                ),
                Metric(
                    "aws_lambda_provisioned_concurrency_utilization", 100.0, levels=(90.0, 95.0)
                ),
            ],
        ),
        (
            "eu-central-1 my_python_test_function ProvisionedAlias",
            _PARAMETERS_WITH_ABSOLUTE_LEVELS,
            _STRING_TABLE_AWS_LAMBDA_PROVISIONED_CONCURRENCY,
            _STRING_TABLE_AWS_LAMBDA_CONCURRENCY,
            _STRING_TABLE_AWS_LAMBDA_REGION_LIMITS,
            [
                Result(state=State.OK, summary="Concurrent executions in percent: 0.20%"),
                Metric("aws_lambda_concurrent_executions_in_percent", 0.2, levels=(90.0, 95.0)),
                Result(
                    state=State.OK, summary="unreserved concurrent executions in percent: 0.10%"
                ),
                Metric(
                    "aws_lambda_unreserved_concurrent_executions_in_percent",
                    0.10050251256281408,
                    levels=(90.0, 95.0),
                ),
                Result(
                    state=State.CRIT,
                    summary="Concurrent executions: 2.00/s (warn/crit at 1.00/s/2.00/s)",
                ),
                Metric("aws_lambda_concurrent_executions", 2.0, levels=(1.0, 2.0)),
                Result(
                    state=State.WARN,
                    summary="unreserved concurrent executions: 1.00/s (warn/crit at 1.00/s/2.00/s)",
                ),
                Metric("aws_lambda_unreserved_concurrent_executions", 1.0, levels=(1.0, 2.0)),
                Result(state=State.OK, summary="provisioned concurrent executions: 0.0167/s"),
                Metric("aws_lambda_provisioned_concurrency_executions", 0.016666666666666666),
                Result(state=State.OK, summary="provisioned concurrency invocations: 0.0167/s"),
                Metric("aws_lambda_provisioned_concurrency_invocations", 0.016666666666666666),
                Result(
                    state=State.CRIT,
                    summary="provisioned concurrency spillover invocations: 0.0017/s (warn/crit at 0.0003/s/0.0003/s)",
                ),
                Metric(
                    "aws_lambda_provisioned_concurrency_spillover_invocations",
                    0.0016666666666666668,
                    levels=(0.00028, 0.00028),
                ),
                Result(
                    state=State.CRIT,
                    summary="provisioned concurrency utilization: 100.00% (warn/crit at 90.00%/95.00%)",
                ),
                Metric(
                    "aws_lambda_provisioned_concurrency_utilization", 100.0, levels=(90.0, 95.0)
                ),
            ],
        ),
    ],
)
def test_end_to_end_parsing_and_check(
    item,
    params,
    string_table_aws_lambda_provisioned_concurrency,
    string_table_aws_lambda,
    string_table_aws_lambda_region_limits,
    results: CheckResult,
) -> None:
    assert (
        list(
            check_aws_lambda_concurrency(
                item,
                params,
                parse_aws_lambda_provisioned_concurrency(
                    string_table_aws_lambda_provisioned_concurrency
                ),
                parse_aws_lambda(string_table_aws_lambda),
                parse_aws_lambda_region_limits(string_table_aws_lambda_region_limits)
                if string_table_aws_lambda_region_limits
                else None,
            )
        )
        == results
    )


_SECTION_AWS_LAMBDA_PROVISIONED_CONCURRENCY = {
    "eu-central-1 calling_other_lambda_concurrently": [
        "eu-central-1 calling_other_lambda_concurrently provisioned_alias",
    ],
    "eu-central-1 my_python_test_function": [],
}

_SECTION_AWS_LAMBDA = {
    "eu-central-1 my_python_test_function": LambdaCloudwatchMetrics(
        ConcurrentExecutions=0.005,
        DeadLetterErrors=None,
        DestinationDeliveryFailures=None,
        Duration=902.43,
        Errors=0.0,
        Invocations=0.005,
        IteratorAge=None,
        PostRuntimeExtensionsDuration=None,
        ProvisionedConcurrencyInvocations=None,
        ProvisionedConcurrencySpilloverInvocations=None,
        ProvisionedConcurrencyUtilization=None,
        ProvisionedConcurrentExecutions=None,
        Throttles=0.0,
        UnreservedConcurrentExecutions=None,
    )
}


@pytest.mark.parametrize(
    "section_aws_lambda_provisioned_concurrency, section_aws_lambda, section_aws_lambda_region_limits, results",
    [
        (
            None,
            None,
            None,
            [],
        ),
        (
            _SECTION_AWS_LAMBDA_PROVISIONED_CONCURRENCY,
            _SECTION_AWS_LAMBDA,
            None,
            [
                Service(item="eu-central-1 calling_other_lambda_concurrently"),
                Service(item="eu-central-1 calling_other_lambda_concurrently provisioned_alias"),
                Service(item="eu-central-1 my_python_test_function"),
            ],
        ),
    ],
)
def test_discover_aws_lambda(
    section_aws_lambda_provisioned_concurrency: Optional[SectionProvisionedConcurrencyAliases],
    section_aws_lambda: Optional[LambdaCloudwatchSection],
    section_aws_lambda_region_limits: Optional[LambdaRegionLimitsSection],
    results: DiscoveryResult,
) -> None:
    assert (
        list(
            discover_aws_lambda_concurrency(
                section_aws_lambda_provisioned_concurrency,
                section_aws_lambda,
                section_aws_lambda_region_limits,
            )
        )
        == results
    )
